"use strict";var l=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var P=(e,s)=>{for(var n in s)l(e,n,{get:s[n],enumerable:!0})},A=(e,s,n,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of U(s))!E.call(e,i)&&i!==n&&l(e,i,{get:()=>s[i],enumerable:!(t=C(s,i))||t.enumerable});return e};var L=e=>A(l({},"__esModule",{value:!0}),e);var x={};P(x,{default:()=>w});module.exports=L(x);var c=require("@raycast/api"),m=require("react");var d=require("@raycast/api"),R=require("react"),{bearerToken:T}=(0,d.getPreferenceValues)(),g="https://api.capacities.io",S={Accept:"application/json",Authorization:`Bearer ${T}`,"Content-Type":"application/json"},D=1e3*60*10,b=1e3*60*10;function I(e){return e===429?"Too Many Requests. Please try again later.":e===400?"Invalid request. Please try again.":e===401?"Unauthorized. Please check your API key.":e===500?"Something went wrong.":e===503||e===555?"Service Unavailable. Please try again later.":"Request failed. You might be offline, please try again when back online."}async function k(){let e=await d.LocalStorage.getItem("capacitiesStore");return e?JSON.parse(e):{spacesLastUpdated:void 0,spaces:[],spacesInfo:{}}}async function h(e,s){let n,t;try{if(t=await k(),e||!t.spacesLastUpdated||Date.now()-new Date(t.spacesLastUpdated).getTime()>D)try{let a=await fetch(`${g}/spaces`,{headers:S});if(!a.ok)throw new Error(I(a.status));let p=await a.json();p.spaces&&(t.spaces=p.spaces.map(o=>({id:o.id,title:o.title})));let f=p?.spaces||[];for(let o of f){let u=t.spaces.findIndex(y=>y.id===o.id);u===-1?t.spaces.push({id:o.id,title:o.title}):t.spaces[u]={id:o.id,title:o.title}}t.spacesLastUpdated=new Date().toISOString()}catch(a){n=`${a}`}let i=[];for(let[a,r]of Object.entries(t.spacesInfo))t.spaces.find(p=>p.id===a)?(e||!r?.lastUpdated||Date.now()-new Date(r?.lastUpdated).getTime()>b)&&i.push(a):delete t.spacesInfo[a];for(let a of t.spaces)t.spacesInfo[a.id]||i.push(a.id);for(let a of i)try{let r=await fetch(`${g}/space-info?spaceid=${a}`,{headers:S});if(!r.ok)throw new Error(I(r.status));let f=await r.json();t.spacesInfo[a]={lastUpdated:new Date().toISOString(),structures:f.structures}}catch(r){n=`${r}`}if(n&&s)throw new Error(n);return await d.LocalStorage.setItem("capacitiesStore",JSON.stringify(t)),t}catch{if(!s&&t)return t;throw new Error(n||"Failed to load Capacities store")}}function w(){async function e(){try{await h(!0,!0),(0,c.showHUD)("Info successfully updated.")}catch(s){(0,c.showHUD)(s instanceof Error?s.message:"Failed to load Capacities store.")}}(0,m.useEffect)(()=>{e().then(()=>(0,c.popToRoot)()),(0,c.closeMainWindow)()},[])}
