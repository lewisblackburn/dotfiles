"use strict";var u=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var k=Object.prototype.hasOwnProperty;var T=(t,e)=>{for(var n in e)u(t,n,{get:e[n],enumerable:!0})},U=(t,e,n,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of x(e))!k.call(t,a)&&a!==n&&u(t,a,{get:()=>e[a],enumerable:!(s=O(e,a))||s.enumerable});return t};var D=t=>U(u({},"__esModule",{value:!0}),t);var F={};T(F,{default:()=>E});module.exports=D(F);var r=require("@raycast/api");var l=require("@raycast/api"),d=require("react/jsx-runtime");function g({title:t,target:e}){return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(l.Action.Open,{title:`${t||"Open"} in Capacities`,icon:"capacities.png",target:`capacities://${e}`,application:"Capacities",onOpen:()=>{(0,l.popToRoot)()}}),(0,d.jsx)(l.Action.OpenInBrowser,{url:`https://app.capacities.io/${e}`,title:`${t||"Open"} in Browser`,onOpen:()=>{(0,l.popToRoot)()}})]})}var P=require("react");var i=require("@raycast/api"),m=require("react"),{communicationToken:R}=(0,i.getPreferenceValues)(),S="http://localhost:10334",C={Accept:"application/json",Authorization:`Bearer ${R}`,"Content-Type":"application/json"},$=0,b=0;function h(t){if(t.ok)return;t.status===401?(0,i.showToast)({style:i.Toast.Style.Failure,title:"You're communication token is invalid",message:"Please update your communication token in the extension preferences and try again.",primaryAction:{title:"Open Extension Preferences",onAction:()=>(0,i.openExtensionPreferences)(),shortcut:{modifiers:["cmd"],key:"o"}}}):(0,i.showToast)({style:i.Toast.Style.Failure,title:"Something went wrong",message:`Error Message: ${t.status} - ${t.statusText}`})}function I(t){t.message.includes("fetch failed")?(0,i.showToast)({style:i.Toast.Style.Failure,title:"Cannot connect",message:"Capacities needs to be open for the extension to work. Please open Capacities and try again. If the problem persists, please check if you activated the extension in the Capacities settings.",primaryAction:{title:"Open Capacities",onAction:()=>(0,i.open)("capacities://","Capacities"),shortcut:{modifiers:["cmd"],key:"o"}}}):(0,i.showToast)({style:i.Toast.Style.Failure,title:"An unexpected error occurred",message:`Capacities needs to be open for the extension to work. Please open Capacities and try again. If the problem persists, please check if you activated the extension in the Capacities settings. (Error Message: ${t.message})`,primaryAction:{title:"Open Capacities",onAction:()=>(0,i.open)("capacities://","Capacities"),shortcut:{modifiers:["cmd"],key:"o"}}})}async function A(){let t=await i.LocalStorage.getItem("capacitiesStore");return t?JSON.parse(t):{spacesLastUpdated:void 0,spaces:[],spacesInfo:{}}}async function _(t){let e;try{if(e=await A(),t||!e.spacesLastUpdated||Date.now()-new Date(e.spacesLastUpdated).getTime()>$){let s=await fetch(`${S}/spaces`,{headers:C});if(!s.ok)return h(s),e;let c=await s.json();c.spaces&&(e.spaces=c.spaces.map(p=>({id:p.id,title:p.title})));let o=c?.spaces||[];for(let p of o){let y=e.spaces.findIndex(L=>L.id===p.id);y===-1?e.spaces.push({id:p.id,title:p.title}):e.spaces[y]={id:p.id,title:p.title}}e.spacesLastUpdated=new Date().toISOString()}let n=[];for(let[s,a]of Object.entries(e.spacesInfo))e.spaces.find(c=>c.id===s)?(t||!a?.lastUpdated||Date.now()-new Date(a?.lastUpdated).getTime()>b)&&n.push(s):delete e.spacesInfo[s];for(let s of e.spaces)e.spacesInfo[s.id]||n.push(s.id);for(let s of n){let a=await fetch(`${S}/space-info?spaceid=${s}`,{headers:C});if(!a.ok)return h(a),e;let o=await a.json();e.spacesInfo[s]={lastUpdated:new Date().toISOString(),structures:o.structures}}return await i.LocalStorage.setItem("capacitiesStore",JSON.stringify(e)),e}catch(n){n instanceof Error?I(n):console.log(n);return}}function w(t=!1){let[e,n]=(0,m.useState)(!0),[s,a]=(0,m.useState)(void 0);function c(){A().then(o=>{a(o),o.spacesLastUpdated&&n(!1)}).catch(o=>{o instanceof Error?I(o):console.log(o)}),_(t).then(o=>{o&&(a(o),o.spacesLastUpdated?n(!1):I(new Error("Failed to load Capacities store")))})}return{store:s,isLoading:e,triggerLoading:c}}var f=require("react/jsx-runtime");function E(){let{isLoading:t,store:e,triggerLoading:n}=w();return(0,P.useEffect)(()=>{n()},[]),(0,f.jsx)(r.List,{isLoading:t,children:e?.spaces.map(s=>(0,f.jsx)(r.List.Item,{title:s.title,icon:r.Icon.Desktop,actions:(0,f.jsxs)(r.ActionPanel,{children:[(0,f.jsx)(g,{target:s.id}),(0,f.jsx)(r.Action.CopyToClipboard,{content:s.id,title:"Copy Space ID"})]})},s.id))})}
