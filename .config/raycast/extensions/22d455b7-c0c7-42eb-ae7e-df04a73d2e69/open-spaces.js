"use strict";var C=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var _=Object.prototype.hasOwnProperty;var G=(e,s)=>{for(var i in s)C(e,i,{get:s[i],enumerable:!0})},N=(e,s,i,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let a of $(s))!_.call(e,a)&&a!==i&&C(e,a,{get:()=>s[a],enumerable:!(t=x(s,a))||t.enumerable});return e};var F=e=>N(C({},"__esModule",{value:!0}),e);var j={};G(j,{default:()=>R});module.exports=F(j);var u=require("@raycast/api");var E=require("@raycast/api"),I=!1;async function L(){if(process.platform!=="darwin"){I=!1;return}I=!!(await(0,E.getApplications)()).find(i=>i.bundleId==="io.capacities.app")}var g=require("@raycast/api");var l=require("react/jsx-runtime");function h({title:e,target:s}){return(0,l.jsxs)(l.Fragment,{children:[I&&(0,l.jsx)(g.Action.Open,{title:`${e||"Open"} in Capacities`,icon:"capacities.png",target:`capacities://${s}`,application:"Capacities",onOpen:()=>{(0,g.popToRoot)()}}),(0,l.jsx)(g.Action.OpenInBrowser,{url:`https://app.capacities.io/${s}`,title:`${e||"Open"} in Browser`,onOpen:()=>{(0,g.popToRoot)()}})]})}var A=require("react");var m=require("@raycast/api"),S=require("react"),{bearerToken:V}=(0,m.getPreferenceValues)(),O="https://api.capacities.io",U={Accept:"application/json",Authorization:`Bearer ${V}`,"Content-Type":"application/json"},v=1e3*60*10,q=1e3*60*10;function T(e){return e===429?"Too Many Requests. Please try again later.":e===400?"Invalid request. Please try again.":e===401?"Unauthorized. Please check your API key.":e===500?"Something went wrong.":e===503||e===555?"Service Unavailable. Please try again later.":"Request failed. You might be offline, please try again when back online."}async function k(){let e=await m.LocalStorage.getItem("capacitiesStore");return e?JSON.parse(e):{spacesLastUpdated:void 0,spaces:[],spacesInfo:{}}}async function B(e,s){let i,t;try{if(t=await k(),e||!t.spacesLastUpdated||Date.now()-new Date(t.spacesLastUpdated).getTime()>v)try{let n=await fetch(`${O}/spaces`,{headers:U});if(!n.ok)throw new Error(T(n.status));let c=await n.json();c.spaces&&(t.spaces=c.spaces.map(d=>({id:d.id,title:d.title})));let o=c?.spaces||[];for(let d of o){let P=t.spaces.findIndex(b=>b.id===d.id);P===-1?t.spaces.push({id:d.id,title:d.title}):t.spaces[P]={id:d.id,title:d.title}}t.spacesLastUpdated=new Date().toISOString()}catch(n){i=`${n}`}let a=[];for(let[n,r]of Object.entries(t.spacesInfo))t.spaces.find(c=>c.id===n)?(e||!r?.lastUpdated||Date.now()-new Date(r?.lastUpdated).getTime()>q)&&a.push(n):delete t.spacesInfo[n];for(let n of t.spaces)t.spacesInfo[n.id]||a.push(n.id);for(let n of a)try{let r=await fetch(`${O}/space-info?spaceid=${n}`,{headers:U});if(!r.ok)throw new Error(T(r.status));let o=await r.json();t.spacesInfo[n]={lastUpdated:new Date().toISOString(),structures:o.structures}}catch(r){i=`${r}`}if(i&&s)throw new Error(i);return await m.LocalStorage.setItem("capacitiesStore",JSON.stringify(t)),t}catch{if(!s&&t)return t;throw new Error(i||"Failed to load Capacities store")}}function D(e=!1){let[s,i]=(0,S.useState)(!0),[t,a]=(0,S.useState)(void 0),[n,r]=(0,S.useState)(void 0);function c(){k().then(o=>{r(o),o.spacesLastUpdated&&i(!1)}).catch(o=>{console.error(o?.message),a("Failed to load Capacities store")}),B(e,!1).then(o=>{r(o),o.spacesLastUpdated?i(!1):a("Failed to load Capacities store")}).catch(o=>{a(o?.message||"Failed to load Capacities store")})}return{store:n,isLoading:s,error:t,triggerLoading:c}}var p=require("@raycast/api"),w=require("react/jsx-runtime");function y({error:e}){return(0,w.jsx)(p.Detail,{markdown:`# Error 
---
 ${e}`,actions:(0,w.jsx)(p.ActionPanel,{children:(0,w.jsx)(p.Action,{icon:p.Icon.Gear,title:"Open Extension Preferences",onAction:p.openExtensionPreferences})})})}var f=require("react/jsx-runtime");function R(){(0,A.useEffect)(()=>{L()},[]);let{isLoading:e,store:s,error:i,triggerLoading:t}=D();return(0,A.useEffect)(()=>{t()},[]),i?(0,f.jsx)(y,{error:i}):(0,f.jsx)(u.List,{isLoading:e,children:s?.spaces.map(a=>(0,f.jsx)(u.List.Item,{title:a.title,actions:(0,f.jsxs)(u.ActionPanel,{children:[(0,f.jsx)(h,{target:a.id}),(0,f.jsx)(u.Action.CopyToClipboard,{content:a.id,title:"Copy Space ID"})]})},a.id))})}
