"use strict";var Z=Object.create;var A=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var X=Object.getPrototypeOf,Q=Object.prototype.hasOwnProperty;var ee=(e,t)=>{for(var r in t)A(e,r,{get:t[r],enumerable:!0})},D=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Y(t))!Q.call(e,o)&&o!==r&&A(e,o,{get:()=>t[o],enumerable:!(n=q(t,o))||n.enumerable});return e};var te=(e,t,r)=>(r=e!=null?Z(X(e)):{},D(t||!e||!e.__esModule?A(r,"default",{value:e,enumerable:!0}):r,e)),re=e=>D(A({},"__esModule",{value:!0}),e);var oe={};ee(oe,{default:()=>G});module.exports=re(oe);var u=require("@raycast/api");var d=te(require("react")),h=require("@raycast/api");var V=require("react/jsx-runtime");function M(e){let t=(0,d.useRef)(e);return t.current=e,t}var O=(function(e){return e.Required="required",e})({});function C(e,t){if(e){if(typeof e=="function")return e(t);if(e==="required"){let r=typeof t<"u"&&t!==null;if(r)switch(typeof t){case"string":r=t.length>0;break;case"object":Array.isArray(t)?r=t.length>0:t instanceof Date&&(r=t.getTime()>0);break;default:break}if(!r)return"The item is required"}}}function N(e){let{onSubmit:t,validation:r,initialValues:n={}}=e,[o,s]=(0,d.useState)(n),[c,f]=(0,d.useState)({}),a=(0,d.useRef)({}),l=M(r||{}),w=M(t),b=(0,d.useCallback)(p=>{a.current[p]?.focus()},[a]),K=(0,d.useCallback)(async p=>{let i=!1;for(let[k,y]of Object.entries(l.current)){let x=C(y,p[k]);x&&(i||(i={},b(k)),i[k]=x)}if(i)return f(i),!1;let g=await w.current(p);return typeof g=="boolean"?g:!0},[l,w,b]),E=(0,d.useCallback)((p,i)=>{f(g=>({...g,[p]:i}))},[f]),_=(0,d.useCallback)(function(p,i){s(g=>({...g,[p]:typeof i=="function"?i(g[p]):i}))},[s]),H=(0,d.useMemo)(()=>new Proxy({},{get(p,i){let g=l.current[i],k=o[i];return{onChange(y){c[i]&&(C(g,y)||E(i,void 0)),_(i,y)},onBlur(y){let x=C(g,y.target.value);x&&E(i,x)},error:c[i],id:i,value:typeof k>"u"?null:k,ref:y=>{a.current[i]=y}}}}),[c,l,E,o,a,_]),J=(0,d.useCallback)(p=>{f({}),Object.entries(a.current).forEach(([i,g])=>{p?.[i]||g?.reset()}),p&&s(p)},[s,f,a]);return{handleSubmit:K,setValidationError:E,setValue:_,values:o,itemProps:H,focus:b,reset:J}}var W=require("@raycast/api"),z=!1;async function F(){if(process.platform!=="darwin"){z=!1;return}z=!!(await(0,W.getApplications)()).find(r=>r.bundleId==="io.capacities.app")}var S=require("react");var v=require("@raycast/api"),R=require("react"),{bearerToken:ne}=(0,v.getPreferenceValues)(),T="https://api.capacities.io",P={Accept:"application/json",Authorization:`Bearer ${ne}`,"Content-Type":"application/json"},ae=1e3*60*10,se=1e3*60*10;function I(e){return e===429?"Too Many Requests. Please try again later.":e===400?"Invalid request. Please try again.":e===401?"Unauthorized. Please check your API key.":e===500?"Something went wrong.":e===503||e===555?"Service Unavailable. Please try again later.":"Request failed. You might be offline, please try again when back online."}async function j(){let e=await v.LocalStorage.getItem("capacitiesStore");return e?JSON.parse(e):{spacesLastUpdated:void 0,spaces:[],spacesInfo:{}}}async function ie(e,t){let r,n;try{if(n=await j(),e||!n.spacesLastUpdated||Date.now()-new Date(n.spacesLastUpdated).getTime()>ae)try{let s=await fetch(`${T}/spaces`,{headers:P});if(!s.ok)throw new Error(I(s.status));let f=await s.json();f.spaces&&(n.spaces=f.spaces.map(l=>({id:l.id,title:l.title})));let a=f?.spaces||[];for(let l of a){let w=n.spaces.findIndex(b=>b.id===l.id);w===-1?n.spaces.push({id:l.id,title:l.title}):n.spaces[w]={id:l.id,title:l.title}}n.spacesLastUpdated=new Date().toISOString()}catch(s){r=`${s}`}let o=[];for(let[s,c]of Object.entries(n.spacesInfo))n.spaces.find(f=>f.id===s)?(e||!c?.lastUpdated||Date.now()-new Date(c?.lastUpdated).getTime()>se)&&o.push(s):delete n.spacesInfo[s];for(let s of n.spaces)n.spacesInfo[s.id]||o.push(s.id);for(let s of o)try{let c=await fetch(`${T}/space-info?spaceid=${s}`,{headers:P});if(!c.ok)throw new Error(I(c.status));let a=await c.json();n.spacesInfo[s]={lastUpdated:new Date().toISOString(),structures:a.structures}}catch(c){r=`${c}`}if(r&&t)throw new Error(r);return await v.LocalStorage.setItem("capacitiesStore",JSON.stringify(n)),n}catch{if(!t&&n)return n;throw new Error(r||"Failed to load Capacities store")}}function B(e=!1){let[t,r]=(0,R.useState)(!0),[n,o]=(0,R.useState)(void 0),[s,c]=(0,R.useState)(void 0);function f(){j().then(a=>{c(a),a.spacesLastUpdated&&r(!1)}).catch(a=>{console.error(a?.message),o("Failed to load Capacities store")}),ie(e,!1).then(a=>{c(a),a.spacesLastUpdated?r(!1):o("Failed to load Capacities store")}).catch(a=>{o(a?.message||"Failed to load Capacities store")})}return{store:s,isLoading:t,error:n,triggerLoading:f}}var $=require("@raycast/api"),U=require("react/jsx-runtime");function L({error:e}){return(0,U.jsx)($.Detail,{markdown:`# Error 
---
 ${e}`,actions:(0,U.jsx)($.ActionPanel,{children:(0,U.jsx)($.Action,{icon:$.Icon.Gear,title:"Open Extension Preferences",onAction:$.openExtensionPreferences})})})}var m=require("react/jsx-runtime");function G(){(0,S.useEffect)(()=>{F()},[]);let{store:e,triggerLoading:t,isLoading:r,error:n}=B();(0,S.useEffect)(()=>{t()},[]);let o=(0,S.useRef)(null),{handleSubmit:s,itemProps:c,setValue:f}=N({async onSubmit(a){let l=await(0,u.showToast)(u.Toast.Style.Animated,"Saving"),w={spaceId:e?.spaces.length===1?e.spaces[0].id:a.spaceId,mdText:a.mdText,origin:"commandPalette",noTimeStamp:a.noTimeStamp};try{let b=await fetch(`${T}/save-to-daily-note`,{method:"POST",headers:P,body:JSON.stringify(w)});if(!b.ok)throw new Error(I(b.status));f("mdText",""),l.style=u.Toast.Style.Success,l.title="Saved"}catch(b){l.style=u.Toast.Style.Failure,l.title="Failed",l.message=`${b}`}},validation:{mdText:O.Required,spaceId:o.current?O.Required:void 0}});return n?(0,m.jsx)(L,{error:n}):(0,m.jsxs)(u.Form,{isLoading:r,actions:(0,m.jsx)(u.ActionPanel,{children:(0,m.jsx)(u.Action.SubmitForm,{title:"Save to Daily Note",icon:u.Icon.CheckCircle,onSubmit:s})}),children:[(0,m.jsx)(u.Form.TextArea,{title:"Note",placeholder:"Daily Note",...c.mdText}),e&&e.spaces.length>1&&(0,m.jsx)(m.Fragment,{children:(0,m.jsx)(u.Form.Dropdown,{title:"Space",...c.spaceId,storeValue:!0,onChange:()=>f("spaceId",""),ref:o,children:e.spaces&&e.spaces.map(a=>(0,m.jsx)(u.Form.Dropdown.Item,{value:a.id,title:a.title},a.id))})}),(0,m.jsx)(u.Form.Checkbox,{label:"No Timestamp",info:"If checked, no time stamp will be added to the note",storeValue:!0,...c.noTimeStamp})]})}
