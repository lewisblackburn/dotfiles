"use strict";var de=Object.create;var V=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var pe=Object.getOwnPropertyNames;var ge=Object.getPrototypeOf,me=Object.prototype.hasOwnProperty;var be=(e,t)=>{for(var r in t)V(e,r,{get:t[r],enumerable:!0})},Z=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let u of pe(t))!me.call(e,u)&&u!==r&&V(e,u,{get:()=>t[u],enumerable:!(n=he(t,u))||n.enumerable});return e};var K=(e,t,r)=>(r=e!=null?de(ge(e)):{},Z(t||!e||!e.__esModule?V(r,"default",{value:e,enumerable:!0}):r,e)),$e=e=>Z(V({},"__esModule",{value:!0}),e);var Ae={};be(Ae,{default:()=>ae});module.exports=$e(Ae);var l=require("@raycast/api"),T=require("react");var P=require("@raycast/api"),I=require("react/jsx-runtime");function H({title:e,target:t}){return(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(P.Action.Open,{title:`${e||"Open"} in Capacities`,icon:"capacities.png",target:`capacities://${t}`,application:"Capacities",onOpen:()=>{(0,P.popToRoot)()}}),(0,I.jsx)(P.Action.OpenInBrowser,{url:`https://app.capacities.io/${t}`,title:`${e||"Open"} in Browser`,onOpen:()=>{(0,P.popToRoot)()}})]})}var p=require("@raycast/api"),J=require("react"),{communicationToken:ye}=(0,p.getPreferenceValues)(),N="http://localhost:10334",W={Accept:"application/json",Authorization:`Bearer ${ye}`,"Content-Type":"application/json"},ke=0,we=0;function z(e){if(e.ok)return;e.status===401?(0,p.showToast)({style:p.Toast.Style.Failure,title:"You're communication token is invalid",message:"Please update your communication token in the extension preferences and try again.",primaryAction:{title:"Open Extension Preferences",onAction:()=>(0,p.openExtensionPreferences)(),shortcut:{modifiers:["cmd"],key:"o"}}}):(0,p.showToast)({style:p.Toast.Style.Failure,title:"Something went wrong",message:`Error Message: ${e.status} - ${e.statusText}`})}function U(e){e.message.includes("fetch failed")?(0,p.showToast)({style:p.Toast.Style.Failure,title:"Cannot connect",message:"Capacities needs to be open for the extension to work. Please open Capacities and try again. If the problem persists, please check if you activated the extension in the Capacities settings.",primaryAction:{title:"Open Capacities",onAction:()=>(0,p.open)("capacities://","Capacities"),shortcut:{modifiers:["cmd"],key:"o"}}}):(0,p.showToast)({style:p.Toast.Style.Failure,title:"An unexpected error occurred",message:`Capacities needs to be open for the extension to work. Please open Capacities and try again. If the problem persists, please check if you activated the extension in the Capacities settings. (Error Message: ${e.message})`,primaryAction:{title:"Open Capacities",onAction:()=>(0,p.open)("capacities://","Capacities"),shortcut:{modifiers:["cmd"],key:"o"}}})}async function q(){let e=await p.LocalStorage.getItem("capacitiesStore");return e?JSON.parse(e):{spacesLastUpdated:void 0,spaces:[],spacesInfo:{}}}async function xe(e){let t;try{if(t=await q(),e||!t.spacesLastUpdated||Date.now()-new Date(t.spacesLastUpdated).getTime()>ke){let n=await fetch(`${N}/spaces`,{headers:W});if(!n.ok)return z(n),t;let d=await n.json();d.spaces&&(t.spaces=d.spaces.map(m=>({id:m.id,title:m.title})));let a=d?.spaces||[];for(let m of a){let k=t.spaces.findIndex(S=>S.id===m.id);k===-1?t.spaces.push({id:m.id,title:m.title}):t.spaces[k]={id:m.id,title:m.title}}t.spacesLastUpdated=new Date().toISOString()}let r=[];for(let[n,u]of Object.entries(t.spacesInfo))t.spaces.find(d=>d.id===n)?(e||!u?.lastUpdated||Date.now()-new Date(u?.lastUpdated).getTime()>we)&&r.push(n):delete t.spacesInfo[n];for(let n of t.spaces)t.spacesInfo[n.id]||r.push(n.id);for(let n of r){let u=await fetch(`${N}/space-info?spaceid=${n}`,{headers:W});if(!u.ok)return z(u),t;let a=await u.json();t.spacesInfo[n]={lastUpdated:new Date().toISOString(),structures:a.structures}}return await p.LocalStorage.setItem("capacitiesStore",JSON.stringify(t)),t}catch(r){r instanceof Error?U(r):console.log(r);return}}function Y(e=!1){let[t,r]=(0,J.useState)(!0),[n,u]=(0,J.useState)(void 0);function d(){q().then(a=>{u(a),a.spacesLastUpdated&&r(!1)}).catch(a=>{a instanceof Error?U(a):console.log(a)}),xe(e).then(a=>{a&&(u(a),a.spacesLastUpdated?r(!1):U(new Error("Failed to load Capacities store")))})}return{store:n,isLoading:t,triggerLoading:d}}var j={gray:{bgLight:"#FAF8F5",textLight:"#44403B",borderLight:"#E7E2D7",bgDark:"#282E36",textDark:"#FFFFFF",borderDark:"#313844"},rose:{bgLight:"#FFEAEC",textLight:"#881337",borderLight:"#FDA4AF",bgDark:"#4B2D38",textDark:"#FFFFFF",borderDark:"#FB7185"},pink:{bgLight:"#FDEDF7",textLight:"#831743",borderLight:"#F9A9D4",bgDark:"#4A2E43",textDark:"#FFFFFF",borderDark:"#F471B5"},fuchsia:{bgLight:"#FBEEFF",textLight:"#701975",borderLight:"#F0ABFD",bgDark:"#462D54",textDark:"#FFFFFF",borderDark:"#E979FA"},purple:{bgLight:"#F7EEFF",textLight:"#581C87",borderLight:"#D8B4FE",bgDark:"#3B3057",textDark:"#FFFFFF",borderDark:"#C084FC"},violet:{bgLight:"#F1EFFE",textLight:"#4C1D95",borderLight:"#C3B6FE",bgDark:"#353157",textDark:"#FFFFFF",borderDark:"#A88BFB"},indigo:{bgLight:"#E8EDFF",textLight:"#302E82",borderLight:"#A5B4FD",bgDark:"#2D3255",textDark:"#FFFFFF",borderDark:"#818CF9"},blue:{bgLight:"#E4EFFE",textLight:"#1F3A8A",borderLight:"#92C5FE",bgDark:"#263956",textDark:"#FFFFFF",borderDark:"#60A5FB"},sky:{bgLight:"#E7F5FE",textLight:"#0C4A6E",borderLight:"#7DD3FC",bgDark:"#224053",textDark:"#FFFFFF",borderDark:"#38BDF9"},cyan:{bgLight:"#DBFBFE",textLight:"#164E63",borderLight:"#67E8FA",bgDark:"#22434F",textDark:"#FFFFFF",borderDark:"#24D3EE"},teal:{bgLight:"#D9FCF6",textLight:"#124E4B",borderLight:"#5EEAD5",bgDark:"#244346",textDark:"#FFFFFF",borderDark:"#2DD4BF"},emerald:{bgLight:"#DDFBEB",textLight:"#064E3B",borderLight:"#6EE7B8",bgDark:"#24433F",textDark:"#FFFFFF",borderDark:"#34D399"},green:{bgLight:"#E4FDED",textLight:"#14532F",borderLight:"#87EFAD",bgDark:"#254638",textDark:"#FFFFFF",borderDark:"#49DE80"},lime:{bgLight:"#F1FCD9",textLight:"#365315",borderLight:"#BFF164",bgDark:"#34472F",textDark:"#FFFFFF",borderDark:"#A3E634"},yellow:{bgLight:"#FFFBD2",textLight:"#713F13",borderLight:"#FDE047",bgDark:"#48422E",textDark:"#FFFFFF",borderDark:"#FACC14"},amber:{bgLight:"#FFF6D6",textLight:"#78350F",borderLight:"#FBD34C",bgDark:"#4B3D2E",textDark:"#FFFFFF",borderDark:"#FBBF24"},orange:{bgLight:"#FFF2E0",textLight:"#7C2D14",borderLight:"#FDBA75",bgDark:"#4B362E",textDark:"#FFFFFF",borderDark:"#FB923C"},red:{bgLight:"#FFE9EA",textLight:"#7F1C1E",borderLight:"#FDA5A5",bgDark:"#4A2D33",textDark:"#FFFFFF",borderDark:"#F87171"}};var f=K(require("react")),c=require("@raycast/api");var Q=Object.prototype.hasOwnProperty;function B(e,t){var r,n;if(e===t)return!0;if(e&&t&&(r=e.constructor)===t.constructor){if(r===Date)return e.getTime()===t.getTime();if(r===RegExp)return e.toString()===t.toString();if(r===Array){if((n=e.length)===t.length)for(;n--&&B(e[n],t[n]););return n===-1}if(!r||typeof e=="object"){n=0;for(r in e)if(Q.call(e,r)&&++n&&!Q.call(t,r)||!(r in t)||!B(e[r],t[r]))return!1;return Object.keys(t).length===n}}return e!==e&&t!==t}var C=K(require("node:fs")),G=K(require("node:path"));var ee=require("react/jsx-runtime");function Se(e){let t=(0,f.useRef)(e),r=(0,f.useRef)(0);return B(e,t.current)||(t.current=e,r.current+=1),(0,f.useMemo)(()=>t.current,[r.current])}function F(e){let t=(0,f.useRef)(e);return t.current=e,t}function ve(e,t){let r=e instanceof Error?e.message:String(e);return(0,c.showToast)({style:c.Toast.Style.Failure,title:t?.title??"Something went wrong",message:t?.message??r,primaryAction:t?.primaryAction??X(e),secondaryAction:t?.primaryAction?X(e):void 0})}var X=e=>{let t=!0,r="[Extension Name]...",n="";try{let a=JSON.parse((0,C.readFileSync)((0,G.join)(c.environment.assetsPath,"..","package.json"),"utf8"));r=`[${a.title}]...`,n=`https://raycast.com/${a.owner||a.author}/${a.name}`,(!a.owner||a.access==="public")&&(t=!1)}catch{}let u=c.environment.isDevelopment||t,d=e instanceof Error?e?.stack||e?.message||"":String(e);return{title:u?"Copy Logs":"Report Error",onAction(a){a.hide(),u?c.Clipboard.copy(d):(0,c.open)(`https://github.com/raycast/extensions/issues/new?&labels=extension%2Cbug&template=extension_bug_report.yml&title=${encodeURIComponent(r)}&extension-url=${encodeURI(n)}&description=${encodeURIComponent(`#### Error:
\`\`\`
${d}
\`\`\`
`)}`)}}};function te(e,t,r){let n=(0,f.useRef)(0),[u,d]=(0,f.useState)({isLoading:!0}),a=F(e),m=F(r?.abortable),k=F(t||[]),S=F(r?.onError),o=F(r?.onData),A=F(r?.onWillExecute),y=F(r?.failureToastOptions),w=F(u.data),v=(0,f.useRef)(null),g=(0,f.useRef)({page:0}),i=(0,f.useRef)(!1),_=(0,f.useRef)(!0),O=(0,f.useRef)(50),x=(0,f.useCallback)(()=>(m.current&&(m.current.current?.abort(),m.current.current=new AbortController),++n.current),[m]),b=(0,f.useCallback)((...E)=>{let $=x();A.current?.(E),d(s=>({...s,isLoading:!0}));let R=Ee(a.current)(...E);function L(s){return s.name=="AbortError"||$===n.current&&(S.current?S.current(s):c.environment.launchType!==c.LaunchType.Background&&ve(s,{title:"Failed to fetch latest data",primaryAction:{title:"Retry",onAction(D){D.hide(),v.current?.(...k.current||[])}},...y.current}),d({error:s,isLoading:!1})),s}return typeof R=="function"?(i.current=!0,R(g.current).then(({data:s,hasMore:D,cursor:ue})=>($===n.current&&(g.current&&(g.current.cursor=ue,g.current.lastItem=s?.[s.length-1]),o.current&&o.current(s,g.current),D&&(O.current=s.length),_.current=D,d(fe=>g.current.page===0?{data:s,isLoading:!1}:{data:(fe.data||[])?.concat(s),isLoading:!1})),s),s=>(_.current=!1,L(s)))):(i.current=!1,R.then(s=>($===n.current&&(o.current&&o.current(s),d({data:s,isLoading:!1})),s),L))},[o,S,k,a,d,v,A,g,y,x]);v.current=b;let M=(0,f.useCallback)(()=>{g.current={page:0};let E=k.current||[];return b(...E)},[b,k]),se=(0,f.useCallback)(async(E,$)=>{let R;try{if($?.optimisticUpdate){x(),typeof $?.rollbackOnError!="function"&&$?.rollbackOnError!==!1&&(R=structuredClone(w.current?.value));let L=$.optimisticUpdate;d(s=>({...s,data:L(s.data)}))}return await E}catch(L){if(typeof $?.rollbackOnError=="function"){let s=$.rollbackOnError;d(D=>({...D,data:s(D.data)}))}else $?.optimisticUpdate&&$?.rollbackOnError!==!1&&d(s=>({...s,data:R}));throw L}finally{$?.shouldRevalidateAfter!==!1&&(c.environment.launchType===c.LaunchType.Background||c.environment.commandMode==="menu-bar"?await M():M())}},[M,w,d,x]),ie=(0,f.useCallback)(()=>{g.current.page+=1;let E=k.current||[];b(...E)},[g,k,b]);(0,f.useEffect)(()=>{g.current={page:0},r?.execute!==!1?b(...t||[]):x()},[Se([t,r?.execute,b]),m,g]),(0,f.useEffect)(()=>()=>{x()},[x]);let oe=r?.execute!==!1?u.isLoading:!1,ce={...u,isLoading:oe},le=i.current?{pageSize:O.current,hasMore:_.current,onLoadMore:ie}:void 0;return{...ce,revalidate:M,mutate:se,pagination:le}}function Ee(e){return e===Promise.all||e===Promise.race||e===Promise.resolve||e===Promise.reject?e.bind(Promise):e}var h=require("react/jsx-runtime"),ne=(i=>(i.RootSpace="Space",i.RootDatabase="Collection",i.RootQuery="Query",i.RootPage="Page",i.MediaImage="Image",i.MediaPDF="PDF",i.MediaAudio="Audio",i.MediaVideo="Video",i.MediaWebResource="Weblink",i.MediaFile="File",i.MediaTweet="Tweet",i.RootAIChat="AI Chat",i.RootSimpleTable="Table",i.RootDailyNote="Daily Note",i.RootTag="Tag",i.RootStructure="Object type",i))(ne||{});function Fe({value:e,spaces:t,onSpaceChange:r}){return(0,h.jsxs)(l.List.Dropdown,{value:e,tooltip:"Select Space",onChange:n=>{r(n)},children:[(0,h.jsx)(l.List.Dropdown.Section,{children:(0,h.jsx)(l.List.Dropdown.Item,{title:"All spaces",value:"all",icon:l.Icon.List},"All")}),(0,h.jsx)(l.List.Dropdown.Section,{title:"Spaces",children:t.map(n=>(0,h.jsx)(l.List.Dropdown.Item,{title:n.title,value:n.id,icon:l.Icon.Desktop},n.id))})]})}var re=new l.Cache;function ae(){let{store:e,triggerLoading:t,isLoading:r}=Y();(0,T.useEffect)(()=>{t()},[]);let[n,u]=(0,T.useState)(re.get("searchSpaceId")||"all"),[d,a]=(0,T.useState)("");function m(o){u(o),re.set("searchSpaceId",o)}(0,T.useEffect)(()=>{n!=="all"&&e?.spaces&&!e?.spaces.find(o=>o.id===n)&&m("all")},[n,e]);let{isLoading:k,data:S}=te(async(o,A)=>{try{let y=A==="all"?e?.spaces?.map(g=>g.id)||[]:[A];if(!o.length||!y.length)return[];let w=await fetch(`${N}/search`,{method:"POST",headers:W,body:JSON.stringify({mode:"fullText",searchTerm:o,spaceIds:y})});return w.ok?(await w.json()).results:(z(w),[])}catch(y){y instanceof Error?U(y):console.log(y)}},[d,n]);return(0,h.jsx)(l.List,{isShowingDetail:!0,isLoading:k||r,onSearchTextChange:a,throttle:!0,searchBarAccessory:e&&e.spaces.length>1?(0,h.jsx)(Fe,{spaces:e.spaces,onSpaceChange:m,value:n}):null,children:d.trim()===""?(0,h.jsx)(l.List.EmptyView,{title:"Type something to get started"}):!S||S.length===0?(0,h.jsx)(l.List.EmptyView,{title:"No results found",icon:l.Icon.MagnifyingGlass}):S.filter(o=>o.title).map((o,A)=>{let y=e?.spacesInfo[o.spaceId]?.structures?.find(b=>b.id===o.structureId),w=y?.title;w?.length||(w=ne[o.structureId]);let v=y?.labelColor||"gray",g=j[v];g||(v="gray",g=j.gray);let i=o.highlights?.find(b=>b.context?.field==="title")?.snippets?.join(" ").replace(/<b>|<\/b>/g,"**").trim();i?.length||(i=o.title),i?.length||(i="Untitled"),i=`## ${i}

`;let O=o.highlights?.filter(b=>b.context?.field!=="title")?.flatMap(b=>b.snippets||[])?.join(`

`).replace(/<b>|<\/b>/g,"**").trim(),x=i+O;return(0,h.jsx)(l.List.Item,{title:o.title,detail:(0,h.jsx)(l.List.Item.Detail,{markdown:x,metadata:(0,h.jsxs)(l.List.Item.Detail.Metadata,{children:[w?.length?(0,h.jsx)(l.List.Item.Detail.Metadata.TagList,{title:"Type",children:(0,h.jsx)(l.List.Item.Detail.Metadata.TagList.Item,{text:w,color:v==="gray"?g.textLight:g.borderLight})}):null,n==="all"?(0,h.jsx)(l.List.Item.Detail.Metadata.TagList,{title:"Space",children:(0,h.jsx)(l.List.Item.Detail.Metadata.TagList.Item,{text:e?.spaces.find(b=>b.id===o.spaceId)?.title||"Unknown",color:j.gray.textLight})}):null]})}),actions:(0,h.jsxs)(l.ActionPanel,{children:[(0,h.jsx)(H,{target:`${o.spaceId}/${o.id}`}),(0,h.jsx)(l.Action.CopyToClipboard,{content:x,title:"Copy Content"})]})},o.id+A)})})}
