"use strict";var be=Object.create;var V=Object.defineProperty;var $e=Object.getOwnPropertyDescriptor;var ye=Object.getOwnPropertyNames;var ke=Object.getPrototypeOf,we=Object.prototype.hasOwnProperty;var xe=(e,t)=>{for(var r in t)V(e,r,{get:t[r],enumerable:!0})},Q=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let c of ye(t))!we.call(e,c)&&c!==r&&V(e,c,{get:()=>t[c],enumerable:!(n=$e(t,c))||n.enumerable});return e};var J=(e,t,r)=>(r=e!=null?be(ke(e)):{},Q(t||!e||!e.__esModule?V(r,"default",{value:e,enumerable:!0}):r,e)),ve=e=>Q(V({},"__esModule",{value:!0}),e);var Pe={};xe(Pe,{default:()=>le});module.exports=ve(Pe);var g=require("@raycast/api"),P=require("react");var L=require("@raycast/api");var X=require("@raycast/api"),N=!1;async function ee(){if(process.platform!=="darwin"){N=!1;return}N=!!(await(0,X.getApplications)()).find(r=>r.bundleId==="io.capacities.app")}var C=require("react/jsx-runtime");function Z({title:e,target:t}){return(0,C.jsxs)(C.Fragment,{children:[N&&(0,C.jsx)(L.Action.Open,{title:`${e||"Open"} in Capacities`,icon:"capacities.png",target:`capacities://${t}`,application:"Capacities",onOpen:()=>{(0,L.popToRoot)()}}),(0,C.jsx)(L.Action.OpenInBrowser,{url:`https://app.capacities.io/${t}`,title:`${e||"Open"} in Browser`,onOpen:()=>{(0,L.popToRoot)()}})]})}var T=require("@raycast/api"),W=require("react"),{bearerToken:Se}=(0,T.getPreferenceValues)(),z="https://api.capacities.io",j={Accept:"application/json",Authorization:`Bearer ${Se}`,"Content-Type":"application/json"},Ee=1e3*60*10,Fe=1e3*60*10;function B(e){return e===429?"Too Many Requests. Please try again later.":e===400?"Invalid request. Please try again.":e===401?"Unauthorized. Please check your API key.":e===500?"Something went wrong.":e===503||e===555?"Service Unavailable. Please try again later.":"Request failed. You might be offline, please try again when back online."}async function te(){let e=await T.LocalStorage.getItem("capacitiesStore");return e?JSON.parse(e):{spacesLastUpdated:void 0,spaces:[],spacesInfo:{}}}async function Ae(e,t){let r,n;try{if(n=await te(),e||!n.spacesLastUpdated||Date.now()-new Date(n.spacesLastUpdated).getTime()>Ee)try{let a=await fetch(`${z}/spaces`,{headers:j});if(!a.ok)throw new Error(B(a.status));let p=await a.json();p.spaces&&(n.spaces=p.spaces.map(m=>({id:m.id,title:m.title})));let f=p?.spaces||[];for(let m of f){let y=n.spaces.findIndex(d=>d.id===m.id);y===-1?n.spaces.push({id:m.id,title:m.title}):n.spaces[y]={id:m.id,title:m.title}}n.spacesLastUpdated=new Date().toISOString()}catch(a){r=`${a}`}let c=[];for(let[a,o]of Object.entries(n.spacesInfo))n.spaces.find(p=>p.id===a)?(e||!o?.lastUpdated||Date.now()-new Date(o?.lastUpdated).getTime()>Fe)&&c.push(a):delete n.spacesInfo[a];for(let a of n.spaces)n.spacesInfo[a.id]||c.push(a.id);for(let a of c)try{let o=await fetch(`${z}/space-info?spaceid=${a}`,{headers:j});if(!o.ok)throw new Error(B(o.status));let f=await o.json();n.spacesInfo[a]={lastUpdated:new Date().toISOString(),structures:f.structures}}catch(o){r=`${o}`}if(r&&t)throw new Error(r);return await T.LocalStorage.setItem("capacitiesStore",JSON.stringify(n)),n}catch{if(!t&&n)return n;throw new Error(r||"Failed to load Capacities store")}}function re(e=!1){let[t,r]=(0,W.useState)(!0),[n,c]=(0,W.useState)(void 0),[a,o]=(0,W.useState)(void 0);function p(){te().then(f=>{o(f),f.spacesLastUpdated&&r(!1)}).catch(f=>{console.error(f?.message),c("Failed to load Capacities store")}),Ae(e,!1).then(f=>{o(f),f.spacesLastUpdated?r(!1):c("Failed to load Capacities store")}).catch(f=>{c(f?.message||"Failed to load Capacities store")})}return{store:a,isLoading:t,error:n,triggerLoading:p}}var O={gray:{bgLight:"#FAF8F5",textLight:"#44403B",borderLight:"#E7E2D7",bgDark:"#282E36",textDark:"#FFFFFF",borderDark:"#313844"},rose:{bgLight:"#FFEAEC",textLight:"#881337",borderLight:"#FDA4AF",bgDark:"#4B2D38",textDark:"#FFFFFF",borderDark:"#FB7185"},pink:{bgLight:"#FDEDF7",textLight:"#831743",borderLight:"#F9A9D4",bgDark:"#4A2E43",textDark:"#FFFFFF",borderDark:"#F471B5"},fuchsia:{bgLight:"#FBEEFF",textLight:"#701975",borderLight:"#F0ABFD",bgDark:"#462D54",textDark:"#FFFFFF",borderDark:"#E979FA"},purple:{bgLight:"#F7EEFF",textLight:"#581C87",borderLight:"#D8B4FE",bgDark:"#3B3057",textDark:"#FFFFFF",borderDark:"#C084FC"},violet:{bgLight:"#F1EFFE",textLight:"#4C1D95",borderLight:"#C3B6FE",bgDark:"#353157",textDark:"#FFFFFF",borderDark:"#A88BFB"},indigo:{bgLight:"#E8EDFF",textLight:"#302E82",borderLight:"#A5B4FD",bgDark:"#2D3255",textDark:"#FFFFFF",borderDark:"#818CF9"},blue:{bgLight:"#E4EFFE",textLight:"#1F3A8A",borderLight:"#92C5FE",bgDark:"#263956",textDark:"#FFFFFF",borderDark:"#60A5FB"},sky:{bgLight:"#E7F5FE",textLight:"#0C4A6E",borderLight:"#7DD3FC",bgDark:"#224053",textDark:"#FFFFFF",borderDark:"#38BDF9"},cyan:{bgLight:"#DBFBFE",textLight:"#164E63",borderLight:"#67E8FA",bgDark:"#22434F",textDark:"#FFFFFF",borderDark:"#24D3EE"},teal:{bgLight:"#D9FCF6",textLight:"#124E4B",borderLight:"#5EEAD5",bgDark:"#244346",textDark:"#FFFFFF",borderDark:"#2DD4BF"},emerald:{bgLight:"#DDFBEB",textLight:"#064E3B",borderLight:"#6EE7B8",bgDark:"#24433F",textDark:"#FFFFFF",borderDark:"#34D399"},green:{bgLight:"#E4FDED",textLight:"#14532F",borderLight:"#87EFAD",bgDark:"#254638",textDark:"#FFFFFF",borderDark:"#49DE80"},lime:{bgLight:"#F1FCD9",textLight:"#365315",borderLight:"#BFF164",bgDark:"#34472F",textDark:"#FFFFFF",borderDark:"#A3E634"},yellow:{bgLight:"#FFFBD2",textLight:"#713F13",borderLight:"#FDE047",bgDark:"#48422E",textDark:"#FFFFFF",borderDark:"#FACC14"},amber:{bgLight:"#FFF6D6",textLight:"#78350F",borderLight:"#FBD34C",bgDark:"#4B3D2E",textDark:"#FFFFFF",borderDark:"#FBBF24"},orange:{bgLight:"#FFF2E0",textLight:"#7C2D14",borderLight:"#FDBA75",bgDark:"#4B362E",textDark:"#FFFFFF",borderDark:"#FB923C"},red:{bgLight:"#FFE9EA",textLight:"#7F1C1E",borderLight:"#FDA5A5",bgDark:"#4A2D33",textDark:"#FFFFFF",borderDark:"#F87171"}};var w=require("@raycast/api"),G=require("react/jsx-runtime");function q({error:e}){return(0,G.jsx)(w.Detail,{markdown:`# Error 
---
 ${e}`,actions:(0,G.jsx)(w.ActionPanel,{children:(0,G.jsx)(w.Action,{icon:w.Icon.Gear,title:"Open Extension Preferences",onAction:w.openExtensionPreferences})})})}var u=J(require("react")),l=require("@raycast/api");var ne=Object.prototype.hasOwnProperty;function K(e,t){var r,n;if(e===t)return!0;if(e&&t&&(r=e.constructor)===t.constructor){if(r===Date)return e.getTime()===t.getTime();if(r===RegExp)return e.toString()===t.toString();if(r===Array){if((n=e.length)===t.length)for(;n--&&K(e[n],t[n]););return n===-1}if(!r||typeof e=="object"){n=0;for(r in e)if(ne.call(e,r)&&++n&&!ne.call(t,r)||!(r in t)||!K(e[r],t[r]))return!1;return Object.keys(t).length===n}}return e!==e&&t!==t}var R=J(require("node:fs")),H=J(require("node:path"));var se=require("react/jsx-runtime");function De(e){let t=(0,u.useRef)(e),r=(0,u.useRef)(0);return K(e,t.current)||(t.current=e,r.current+=1),(0,u.useMemo)(()=>t.current,[r.current])}function S(e){let t=(0,u.useRef)(e);return t.current=e,t}function Ie(e,t){let r=e instanceof Error?e.message:String(e);return(0,l.showToast)({style:l.Toast.Style.Failure,title:t?.title??"Something went wrong",message:t?.message??r,primaryAction:t?.primaryAction??ae(e),secondaryAction:t?.primaryAction?ae(e):void 0})}var ae=e=>{let t=!0,r="[Extension Name]...",n="";try{let o=JSON.parse((0,R.readFileSync)((0,H.join)(l.environment.assetsPath,"..","package.json"),"utf8"));r=`[${o.title}]...`,n=`https://raycast.com/${o.owner||o.author}/${o.name}`,(!o.owner||o.access==="public")&&(t=!1)}catch{}let c=l.environment.isDevelopment||t,a=e instanceof Error?e?.stack||e?.message||"":String(e);return{title:c?"Copy Logs":"Report Error",onAction(o){o.hide(),c?l.Clipboard.copy(a):(0,l.open)(`https://github.com/raycast/extensions/issues/new?&labels=extension%2Cbug&template=extension_bug_report.yml&title=${encodeURIComponent(r)}&extension-url=${encodeURI(n)}&description=${encodeURIComponent(`#### Error:
\`\`\`
${a}
\`\`\`
`)}`)}}};function ie(e,t,r){let n=(0,u.useRef)(0),[c,a]=(0,u.useState)({isLoading:!0}),o=S(e),p=S(r?.abortable),f=S(t||[]),m=S(r?.onError),y=S(r?.onData),d=S(r?.onWillExecute),E=S(r?.failureToastOptions),x=S(c.data),k=(0,u.useRef)(null),h=(0,u.useRef)({page:0}),s=(0,u.useRef)(!1),F=(0,u.useRef)(!0),Y=(0,u.useRef)(50),A=(0,u.useCallback)(()=>(p.current&&(p.current.current?.abort(),p.current.current=new AbortController),++n.current),[p]),D=(0,u.useCallback)((...v)=>{let $=A();d.current?.(v),a(i=>({...i,isLoading:!0}));let U=Ce(o.current)(...v);function _(i){return i.name=="AbortError"||$===n.current&&(m.current?m.current(i):l.environment.launchType!==l.LaunchType.Background&&Ie(i,{title:"Failed to fetch latest data",primaryAction:{title:"Retry",onAction(I){I.hide(),k.current?.(...f.current||[])}},...E.current}),a({error:i,isLoading:!1})),i}return typeof U=="function"?(s.current=!0,U(h.current).then(({data:i,hasMore:I,cursor:ge})=>($===n.current&&(h.current&&(h.current.cursor=ge,h.current.lastItem=i?.[i.length-1]),y.current&&y.current(i,h.current),I&&(Y.current=i.length),F.current=I,a(me=>h.current.page===0?{data:i,isLoading:!1}:{data:(me.data||[])?.concat(i),isLoading:!1})),i),i=>(F.current=!1,_(i)))):(s.current=!1,U.then(i=>($===n.current&&(y.current&&y.current(i),a({data:i,isLoading:!1})),i),_))},[y,m,f,o,a,k,d,h,E,A]);k.current=D;let M=(0,u.useCallback)(()=>{h.current={page:0};let v=f.current||[];return D(...v)},[D,f]),ue=(0,u.useCallback)(async(v,$)=>{let U;try{if($?.optimisticUpdate){A(),typeof $?.rollbackOnError!="function"&&$?.rollbackOnError!==!1&&(U=structuredClone(x.current?.value));let _=$.optimisticUpdate;a(i=>({...i,data:_(i.data)}))}return await v}catch(_){if(typeof $?.rollbackOnError=="function"){let i=$.rollbackOnError;a(I=>({...I,data:i(I.data)}))}else $?.optimisticUpdate&&$?.rollbackOnError!==!1&&a(i=>({...i,data:U}));throw _}finally{$?.shouldRevalidateAfter!==!1&&(l.environment.launchType===l.LaunchType.Background||l.environment.commandMode==="menu-bar"?await M():M())}},[M,x,a,A]),fe=(0,u.useCallback)(()=>{h.current.page+=1;let v=f.current||[];D(...v)},[h,f,D]);(0,u.useEffect)(()=>{h.current={page:0},r?.execute!==!1?D(...t||[]):A()},[De([t,r?.execute,D]),p,h]),(0,u.useEffect)(()=>()=>{A()},[A]);let de=r?.execute!==!1?c.isLoading:!1,he={...c,isLoading:de},pe=s.current?{pageSize:Y.current,hasMore:F.current,onLoadMore:fe}:void 0;return{...he,revalidate:M,mutate:ue,pagination:pe}}function Ce(e){return e===Promise.all||e===Promise.race||e===Promise.resolve||e===Promise.reject?e.bind(Promise):e}var b=require("react/jsx-runtime"),ce=(s=>(s.RootSpace="Space",s.RootDatabase="Collection",s.RootQuery="Query",s.RootPage="Page",s.MediaImage="Image",s.MediaPDF="PDF",s.MediaAudio="Audio",s.MediaVideo="Video",s.MediaWebResource="Weblink",s.MediaFile="File",s.MediaTweet="Tweet",s.RootAIChat="AI Chat",s.RootSimpleTable="Table",s.RootDailyNote="Daily Note",s.RootTag="Tag",s.RootStructure="Object type",s))(ce||{});function Re({value:e,spaces:t,onSpaceChange:r}){return(0,b.jsx)(g.List.Dropdown,{value:e,tooltip:"Select Space",onChange:n=>{r(n)},children:(0,b.jsxs)(g.List.Dropdown.Section,{title:"Spaces",children:[(0,b.jsx)(g.List.Dropdown.Item,{title:"All spaces",value:"all"},"All"),t.map(n=>(0,b.jsx)(g.List.Dropdown.Item,{title:n.title,value:n.id},n.id))]})})}var oe=new g.Cache;function le(){(0,P.useEffect)(()=>{ee()},[]);let{store:e,triggerLoading:t,error:r,isLoading:n}=re();(0,P.useEffect)(()=>{t()},[]);let[c,a]=(0,P.useState)(oe.get("searchSpaceId")||"all"),[o,p]=(0,P.useState)("");function f(d){a(d),oe.set("searchSpaceId",d)}(0,P.useEffect)(()=>{c!=="all"&&e?.spaces&&!e?.spaces.find(d=>d.id===c)&&f("all")},[c,e]);let{isLoading:m,data:y}=ie(async(d,E)=>{let x=E==="all"?e?.spaces?.map(s=>s.id)||[]:[E];if(!d.length||!x.length)return[];let k=await fetch(`${z}/search`,{method:"POST",headers:j,body:JSON.stringify({mode:"title",searchTerm:d,spaceIds:x})});if(!k.ok)throw new Error(B(k.status));return(await k.json()).results},[o,c]);return r?(0,b.jsx)(q,{error:r}):(0,b.jsx)(g.List,{isLoading:m||n,onSearchTextChange:p,throttle:!0,searchBarAccessory:e&&e.spaces.length>1?(0,b.jsx)(Re,{spaces:e.spaces,onSpaceChange:f,value:c}):null,children:o.trim()===""?(0,b.jsx)(g.List.EmptyView,{title:"Type something to get started"}):!y||y.length===0?(0,b.jsx)(g.List.EmptyView,{title:"No results found",icon:g.Icon.Number00}):y.filter(d=>d.title).map((d,E)=>{let x=e?.spacesInfo[d.spaceId]?.structures?.find(F=>F.id===d.structureId),k=x?.title;k?.length||(k=ce[d.structureId]);let h=x?.labelColor||"gray",s=O[h];return s||(h="gray",s=O.gray),(0,b.jsx)(g.List.Item,{title:d.title,accessories:[k?.length?{tag:{value:k,color:{light:h==="gray"?s.textLight:s.borderLight,dark:h==="gray"?s.textDark:s.borderDark,adjustContrast:!1}}}:{},c==="all"?{tag:{value:e?.spaces.find(F=>F.id===d.spaceId)?.title||"Unknown",color:{light:O.gray.textLight,dark:O.gray.textDark,adjustContrast:!1}}}:{}],actions:(0,b.jsx)(g.ActionPanel,{children:(0,b.jsx)(Z,{target:`${d.spaceId}/${d.id}`})})},d.id+E)})})}
