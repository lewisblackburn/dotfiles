"use strict";var B=Object.create;var E=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,J=Object.prototype.hasOwnProperty;var Z=(e,t)=>{for(var n in t)E(e,n,{get:t[n],enumerable:!0})},_=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of H(t))!J.call(e,o)&&o!==n&&E(e,o,{get:()=>t[o],enumerable:!(s=G(t,o))||s.enumerable});return e};var q=(e,t,n)=>(n=e!=null?B(K(e)):{},_(t||!e||!e.__esModule?E(n,"default",{value:e,enumerable:!0}):n,e)),Y=e=>_(E({},"__esModule",{value:!0}),e);var re={};Z(re,{default:()=>N});module.exports=Y(re);var r=require("@raycast/api");var h=q(require("react")),m=require("@raycast/api");var D=require("react/jsx-runtime");function O(e){let t=(0,h.useRef)(e);return t.current=e,t}var L=(function(e){return e.Required="required",e})({});function P(e,t){if(e){if(typeof e=="function")return e(t);if(e==="required"){let n=typeof t<"u"&&t!==null;if(n)switch(typeof t){case"string":n=t.length>0;break;case"object":Array.isArray(t)?n=t.length>0:t instanceof Date&&(n=t.getTime()>0);break;default:break}if(!n)return"The item is required"}}}function M(e){let{onSubmit:t,validation:n,initialValues:s={}}=e,[o,d]=(0,h.useState)(s),[c,a]=(0,h.useState)({}),l=(0,h.useRef)({}),$=O(n||{}),x=O(t),p=(0,h.useCallback)(g=>{l.current[g]?.focus()},[l]),z=(0,h.useCallback)(async g=>{let i=!1;for(let[w,y]of Object.entries($.current)){let k=P(y,g[w]);k&&(i||(i={},p(w)),i[w]=k)}if(i)return a(i),!1;let b=await x.current(g);return typeof b=="boolean"?b:!0},[$,x,p]),S=(0,h.useCallback)((g,i)=>{a(b=>({...b,[g]:i}))},[a]),C=(0,h.useCallback)(function(g,i){d(b=>({...b,[g]:typeof i=="function"?i(b[g]):i}))},[d]),F=(0,h.useMemo)(()=>new Proxy({},{get(g,i){let b=$.current[i],w=o[i];return{onChange(y){c[i]&&(P(b,y)||S(i,void 0)),C(i,y)},onBlur(y){let k=P(b,y.target.value);k&&S(i,k)},error:c[i],id:i,value:typeof w>"u"?null:w,ref:y=>{l.current[i]=y}}}}),[c,$,S,o,l,C]),j=(0,h.useCallback)(g=>{a({}),Object.entries(l.current).forEach(([i,b])=>{g?.[i]||b?.reset()}),g&&d(g)},[d,a,l]);return{handleSubmit:z,setValidationError:S,setValue:C,values:o,itemProps:F,focus:p,reset:j}}var I=require("react");var u=require("@raycast/api"),U=require("react"),{communicationToken:X}=(0,u.getPreferenceValues)(),A="http://localhost:10334",T={Accept:"application/json",Authorization:`Bearer ${X}`,"Content-Type":"application/json"},Q=0,ee=0;function R(e){if(e.ok)return;e.status===401?(0,u.showToast)({style:u.Toast.Style.Failure,title:"You're communication token is invalid",message:"Please update your communication token in the extension preferences and try again.",primaryAction:{title:"Open Extension Preferences",onAction:()=>(0,u.openExtensionPreferences)(),shortcut:{modifiers:["cmd"],key:"o"}}}):(0,u.showToast)({style:u.Toast.Style.Failure,title:"Something went wrong",message:`Error Message: ${e.status} - ${e.statusText}`})}function v(e){e.message.includes("fetch failed")?(0,u.showToast)({style:u.Toast.Style.Failure,title:"Cannot connect",message:"Capacities needs to be open for the extension to work. Please open Capacities and try again. If the problem persists, please check if you activated the extension in the Capacities settings.",primaryAction:{title:"Open Capacities",onAction:()=>(0,u.open)("capacities://","Capacities"),shortcut:{modifiers:["cmd"],key:"o"}}}):(0,u.showToast)({style:u.Toast.Style.Failure,title:"An unexpected error occurred",message:`Capacities needs to be open for the extension to work. Please open Capacities and try again. If the problem persists, please check if you activated the extension in the Capacities settings. (Error Message: ${e.message})`,primaryAction:{title:"Open Capacities",onAction:()=>(0,u.open)("capacities://","Capacities"),shortcut:{modifiers:["cmd"],key:"o"}}})}async function V(){let e=await u.LocalStorage.getItem("capacitiesStore");return e?JSON.parse(e):{spacesLastUpdated:void 0,spaces:[],spacesInfo:{}}}async function te(e){let t;try{if(t=await V(),e||!t.spacesLastUpdated||Date.now()-new Date(t.spacesLastUpdated).getTime()>Q){let s=await fetch(`${A}/spaces`,{headers:T});if(!s.ok)return R(s),t;let d=await s.json();d.spaces&&(t.spaces=d.spaces.map(a=>({id:a.id,title:a.title})));let c=d?.spaces||[];for(let a of c){let l=t.spaces.findIndex($=>$.id===a.id);l===-1?t.spaces.push({id:a.id,title:a.title}):t.spaces[l]={id:a.id,title:a.title}}t.spacesLastUpdated=new Date().toISOString()}let n=[];for(let[s,o]of Object.entries(t.spacesInfo))t.spaces.find(d=>d.id===s)?(e||!o?.lastUpdated||Date.now()-new Date(o?.lastUpdated).getTime()>ee)&&n.push(s):delete t.spacesInfo[s];for(let s of t.spaces)t.spacesInfo[s.id]||n.push(s.id);for(let s of n){let o=await fetch(`${A}/space-info?spaceid=${s}`,{headers:T});if(!o.ok)return R(o),t;let c=await o.json();t.spacesInfo[s]={lastUpdated:new Date().toISOString(),structures:c.structures}}return await u.LocalStorage.setItem("capacitiesStore",JSON.stringify(t)),t}catch(n){n instanceof Error?v(n):console.log(n);return}}function W(e=!1){let[t,n]=(0,U.useState)(!0),[s,o]=(0,U.useState)(void 0);function d(){V().then(c=>{o(c),c.spacesLastUpdated&&n(!1)}).catch(c=>{c instanceof Error?v(c):console.log(c)}),te(e).then(c=>{c&&(o(c),c.spacesLastUpdated?n(!1):v(new Error("Failed to load Capacities store")))})}return{store:s,isLoading:t,triggerLoading:d}}var f=require("react/jsx-runtime");function N(){let{store:e,triggerLoading:t,isLoading:n}=W();(0,I.useEffect)(()=>{t()},[]);let s=(0,I.useRef)(null),{handleSubmit:o,itemProps:d,setValue:c}=M({async onSubmit(a){(0,r.showToast)({style:r.Toast.Style.Animated,title:"Saving"});let l=a.date,$;if(l)if((l.getMilliseconds()===0||l.getMilliseconds()===1)&&l.getSeconds()===0&&l.getMinutes()===0&&l.getHours()===0){let p=new Date;p.setUTCHours(0,0,0,0),p.setUTCDate(l.getDate()),p.setUTCMonth(l.getMonth()),p.setUTCFullYear(l.getFullYear()),$={dateResolution:"day",startTime:p.toISOString()}}else $={dateResolution:"time",startTime:l.toISOString()};let x={spaceId:e?.spaces.length===1?e.spaces[0].id:a.spaceId,title:a.title,mdText:a.mdText?.trim()?.length?a.mdText.trim():void 0,priority:a.priority==="empty"?void 0:a.priority,date:$};console.log(x);try{let p=await fetch(`${A}/save-task`,{method:"POST",headers:T,body:JSON.stringify(x)});if(!p.ok){R(p);return}(0,r.showToast)({style:r.Toast.Style.Success,title:"Saved"}),(0,r.showHUD)("Task created"),(0,r.closeMainWindow)()}catch(p){p instanceof Error?v(p):console.log(p)}},validation:{title(a){if(!a||a.trim()==="")return"A title is required"},spaceId:s.current?L.Required:void 0}});return(0,f.jsxs)(r.Form,{isLoading:n,actions:(0,f.jsx)(r.ActionPanel,{children:(0,f.jsx)(r.Action.SubmitForm,{title:"Create Task",icon:r.Icon.CheckCircle,onSubmit:o})}),children:[e&&e.spaces.length>1&&(0,f.jsx)(f.Fragment,{children:(0,f.jsx)(r.Form.Dropdown,{title:"Space",...d.spaceId,storeValue:!0,onChange:()=>c("spaceId",""),ref:s,children:e.spaces&&e.spaces.map(a=>(0,f.jsx)(r.Form.Dropdown.Item,{value:a.id,title:a.title,icon:r.Icon.Desktop},a.id))})}),(0,f.jsx)(r.Form.TextField,{title:"Title",...d.title,autoFocus:!0}),(0,f.jsx)(r.Form.Separator,{}),(0,f.jsxs)(r.Form.Dropdown,{id:"priority",title:"Priority",defaultValue:"empty",children:[(0,f.jsx)(r.Form.Dropdown.Item,{value:"empty",title:"No Priority",icon:r.Icon.Minus}),(0,f.jsx)(r.Form.Dropdown.Item,{value:"low",title:"Low",icon:r.Icon.Exclamationmark}),(0,f.jsx)(r.Form.Dropdown.Item,{value:"medium",title:"Medium",icon:r.Icon.Exclamationmark2}),(0,f.jsx)(r.Form.Dropdown.Item,{value:"high",title:"High",icon:r.Icon.Exclamationmark3})]}),(0,f.jsx)(r.Form.DatePicker,{id:"date",title:"Date",defaultValue:null}),(0,f.jsx)(r.Form.TextArea,{title:"Notes",...d.mdText,info:"Optional. Notes can be formatted in markdown."})]})}
