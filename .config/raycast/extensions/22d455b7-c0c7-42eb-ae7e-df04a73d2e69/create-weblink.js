"use strict";var Ie=Object.create;var z=Object.defineProperty;var Ce=Object.getOwnPropertyDescriptor;var Pe=Object.getOwnPropertyNames;var _e=Object.getPrototypeOf,Oe=Object.prototype.hasOwnProperty;var Le=(e,t)=>{for(var r in t)z(e,r,{get:t[r],enumerable:!0})},re=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Pe(t))!Oe.call(e,s)&&s!==r&&z(e,s,{get:()=>t[s],enumerable:!(n=Ce(t,s))||n.enumerable});return e};var W=(e,t,r)=>(r=e!=null?Ie(_e(e)):{},re(t||!e||!e.__esModule?z(r,"default",{value:e,enumerable:!0}):r,e)),De=e=>re(z({},"__esModule",{value:!0}),e);var tt={};Le(tt,{default:()=>ve});module.exports=De(tt);var p=require("@raycast/api");var u=W(require("react")),d=require("@raycast/api");var ne=Object.prototype.hasOwnProperty;function N(e,t){var r,n;if(e===t)return!0;if(e&&t&&(r=e.constructor)===t.constructor){if(r===Date)return e.getTime()===t.getTime();if(r===RegExp)return e.toString()===t.toString();if(r===Array){if((n=e.length)===t.length)for(;n--&&N(e[n],t[n]););return n===-1}if(!r||typeof e=="object"){n=0;for(r in e)if(ne.call(e,r)&&++n&&!ne.call(t,r)||!(r in t)||!N(e[r],t[r]))return!1;return Object.keys(t).length===n}}return e!==e&&t!==t}var P=W(require("node:fs")),j=W(require("node:path"));var ce=W(require("node:child_process")),le=require("node:buffer"),D=W(require("node:stream")),ue=require("node:util");var fe=require("react/jsx-runtime");var J=globalThis;function Me(e){let t=(0,u.useRef)(e),r=(0,u.useRef)(0);return N(e,t.current)||(t.current=e,r.current+=1),(0,u.useMemo)(()=>t.current,[r.current])}function S(e){let t=(0,u.useRef)(e);return t.current=e,t}function We(e,t){let r=e instanceof Error?e.message:String(e);return(0,d.showToast)({style:d.Toast.Style.Failure,title:t?.title??"Something went wrong",message:t?.message??r,primaryAction:t?.primaryAction??ae(e),secondaryAction:t?.primaryAction?ae(e):void 0})}var ae=e=>{let t=!0,r="[Extension Name]...",n="";try{let o=JSON.parse((0,P.readFileSync)((0,j.join)(d.environment.assetsPath,"..","package.json"),"utf8"));r=`[${o.title}]...`,n=`https://raycast.com/${o.owner||o.author}/${o.name}`,(!o.owner||o.access==="public")&&(t=!1)}catch{}let s=d.environment.isDevelopment||t,a=e instanceof Error?e?.stack||e?.message||"":String(e);return{title:s?"Copy Logs":"Report Error",onAction(o){o.hide(),s?d.Clipboard.copy(a):(0,d.open)(`https://github.com/raycast/extensions/issues/new?&labels=extension%2Cbug&template=extension_bug_report.yml&title=${encodeURIComponent(r)}&extension-url=${encodeURI(n)}&description=${encodeURIComponent(`#### Error:
\`\`\`
${a}
\`\`\`
`)}`)}}};function de(e,t,r){let n=(0,u.useRef)(0),[s,a]=(0,u.useState)({isLoading:!0}),o=S(e),l=S(r?.abortable),i=S(t||[]),c=S(r?.onError),m=S(r?.onData),$=S(r?.onWillExecute),T=S(r?.failureToastOptions),E=S(s.data),A=(0,u.useRef)(null),y=(0,u.useRef)({page:0}),I=(0,u.useRef)(!1),g=(0,u.useRef)(!0),h=(0,u.useRef)(50),b=(0,u.useCallback)(()=>(l.current&&(l.current.current?.abort(),l.current.current=new AbortController),++n.current),[l]),w=(0,u.useCallback)((...U)=>{let x=b();$.current?.(U),a(f=>({...f,isLoading:!0}));let O=Ve(o.current)(...U);function L(f){return f.name=="AbortError"||x===n.current&&(c.current?c.current(f):d.environment.launchType!==d.LaunchType.Background&&We(f,{title:"Failed to fetch latest data",primaryAction:{title:"Retry",onAction(C){C.hide(),A.current?.(...i.current||[])}},...T.current}),a({error:f,isLoading:!1})),f}return typeof O=="function"?(I.current=!0,O(y.current).then(({data:f,hasMore:C,cursor:Re})=>(x===n.current&&(y.current&&(y.current.cursor=Re,y.current.lastItem=f?.[f.length-1]),m.current&&m.current(f,y.current),C&&(h.current=f.length),g.current=C,a(Ue=>y.current.page===0?{data:f,isLoading:!1}:{data:(Ue.data||[])?.concat(f),isLoading:!1})),f),f=>(g.current=!1,L(f)))):(I.current=!1,O.then(f=>(x===n.current&&(m.current&&m.current(f),a({data:f,isLoading:!1})),f),L))},[m,c,i,o,a,A,$,y,T,b]);A.current=w;let k=(0,u.useCallback)(()=>{y.current={page:0};let U=i.current||[];return w(...U)},[w,i]),R=(0,u.useCallback)(async(U,x)=>{let O;try{if(x?.optimisticUpdate){b(),typeof x?.rollbackOnError!="function"&&x?.rollbackOnError!==!1&&(O=structuredClone(E.current?.value));let L=x.optimisticUpdate;a(f=>({...f,data:L(f.data)}))}return await U}catch(L){if(typeof x?.rollbackOnError=="function"){let f=x.rollbackOnError;a(C=>({...C,data:f(C.data)}))}else x?.optimisticUpdate&&x?.rollbackOnError!==!1&&a(f=>({...f,data:O}));throw L}finally{x?.shouldRevalidateAfter!==!1&&(d.environment.launchType===d.LaunchType.Background||d.environment.commandMode==="menu-bar"?await k():k())}},[k,E,a,b]),Se=(0,u.useCallback)(()=>{y.current.page+=1;let U=i.current||[];w(...U)},[y,i,w]);(0,u.useEffect)(()=>{y.current={page:0},r?.execute!==!1?w(...t||[]):b()},[Me([t,r?.execute,w]),l,y]),(0,u.useEffect)(()=>()=>{b()},[b]);let Ee=r?.execute!==!1?s.isLoading:!1,Ae={...s,isLoading:Ee},Te=I.current?{pageSize:h.current,hasMore:g.current,onLoadMore:Se}:void 0;return{...Ae,revalidate:k,mutate:R,pagination:Te}}function Ve(e){return e===Promise.all||e===Promise.race||e===Promise.resolve||e===Promise.reject?e.bind(Promise):e}var F=e=>!!e&&typeof e=="object"&&typeof e.removeListener=="function"&&typeof e.emit=="function"&&typeof e.reallyExit=="function"&&typeof e.listeners=="function"&&typeof e.kill=="function"&&typeof e.pid=="number"&&typeof e.on=="function",Z=Symbol.for("signal-exit emitter"),X=class{constructor(){if(this.emitted={afterExit:!1,exit:!1},this.listeners={afterExit:[],exit:[]},this.count=0,this.id=Math.random(),J[Z])return J[Z];Object.defineProperty(J,Z,{value:this,writable:!1,enumerable:!1,configurable:!1})}on(t,r){this.listeners[t].push(r)}removeListener(t,r){let n=this.listeners[t],s=n.indexOf(r);s!==-1&&(s===0&&n.length===1?n.length=0:n.splice(s,1))}emit(t,r,n){if(this.emitted[t])return!1;this.emitted[t]=!0;let s=!1;for(let a of this.listeners[t])s=a(r,n)===!0||s;return t==="exit"&&(s=this.emit("afterExit",r,n)||s),s}},Q=class{onExit(){return()=>{}}load(){}unload(){}},ee=class{#o;#t;#e;#s;#i;#a;#n;#r;constructor(t){this.#o=process.platform==="win32"?"SIGINT":"SIGHUP",this.#t=new X,this.#a={},this.#n=!1,this.#r=[],this.#r.push("SIGHUP","SIGINT","SIGTERM"),globalThis.process.platform!=="win32"&&this.#r.push("SIGALRM","SIGABRT","SIGVTALRM","SIGXCPU","SIGXFSZ","SIGUSR2","SIGTRAP","SIGSYS","SIGQUIT","SIGIOT"),globalThis.process.platform==="linux"&&this.#r.push("SIGIO","SIGPOLL","SIGPWR","SIGSTKFLT"),this.#e=t,this.#a={};for(let r of this.#r)this.#a[r]=()=>{let n=this.#e.listeners(r),{count:s}=this.#t,a=t;if(typeof a.__signal_exit_emitter__=="object"&&typeof a.__signal_exit_emitter__.count=="number"&&(s+=a.__signal_exit_emitter__.count),n.length===s){this.unload();let o=this.#t.emit("exit",null,r),l=r==="SIGHUP"?this.#o:r;o||t.kill(t.pid,l)}};this.#i=t.reallyExit,this.#s=t.emit}onExit(t,r){if(!F(this.#e))return()=>{};this.#n===!1&&this.load();let n=r?.alwaysLast?"afterExit":"exit";return this.#t.on(n,t),()=>{this.#t.removeListener(n,t),this.#t.listeners.exit.length===0&&this.#t.listeners.afterExit.length===0&&this.unload()}}load(){if(!this.#n){this.#n=!0,this.#t.count+=1;for(let t of this.#r)try{let r=this.#a[t];r&&this.#e.on(t,r)}catch{}this.#e.emit=(t,...r)=>this.#l(t,...r),this.#e.reallyExit=t=>this.#c(t)}}unload(){this.#n&&(this.#n=!1,this.#r.forEach(t=>{let r=this.#a[t];if(!r)throw new Error("Listener not defined for signal: "+t);try{this.#e.removeListener(t,r)}catch{}}),this.#e.emit=this.#s,this.#e.reallyExit=this.#i,this.#t.count-=1)}#c(t){return F(this.#e)?(this.#e.exitCode=t||0,this.#t.emit("exit",this.#e.exitCode,null),this.#i.call(this.#e,this.#e.exitCode)):0}#l(t,...r){let n=this.#s;if(t==="exit"&&F(this.#e)){typeof r[0]=="number"&&(this.#e.exitCode=r[0]);let s=n.call(this.#e,t,...r);return this.#t.emit("exit",this.#e.exitCode,null),s}else return n.call(this.#e,t,...r)}},q=null,ze=(e,t)=>(q||(q=F(process)?new ee(process):new Q),q.onExit(e,t));function Ne(e,{timeout:t}={}){let r=new Promise((l,i)=>{e.on("exit",(c,m)=>{l({exitCode:c,signal:m,timedOut:!1})}),e.on("error",c=>{i(c)}),e.stdin&&e.stdin.on("error",c=>{i(c)})}),n=ze(()=>{e.kill()});if(t===0||t===void 0)return r.finally(()=>n());let s,a=new Promise((l,i)=>{s=setTimeout(()=>{e.kill("SIGTERM"),i(Object.assign(new Error("Timed out"),{timedOut:!0,signal:"SIGTERM"}))},t)}),o=r.finally(()=>{clearTimeout(s)});return Promise.race([a,o]).finally(()=>n())}var te=class extends Error{constructor(){super("The output is too big"),this.name="MaxBufferError"}};function Fe(e){let{encoding:t}=e,r=t==="buffer",n=new D.default.PassThrough({objectMode:!1});t&&t!=="buffer"&&n.setEncoding(t);let s=0,a=[];return n.on("data",o=>{a.push(o),s+=o.length}),n.getBufferedValue=()=>r?Buffer.concat(a,s):a.join(""),n.getBufferedLength=()=>s,n}async function se(e,t){let r=Fe(t);return await new Promise((n,s)=>{let a=o=>{o&&r.getBufferedLength()<=le.constants.MAX_LENGTH&&(o.bufferedData=r.getBufferedValue()),s(o)};(async()=>{try{await(0,ue.promisify)(D.default.pipeline)(e,r),n()}catch(o){a(o)}})(),r.on("data",()=>{r.getBufferedLength()>8e7&&a(new te)})}),r.getBufferedValue()}async function ie(e,t){e.destroy();try{return await t}catch(r){return r.bufferedData}}async function je({stdout:e,stderr:t},{encoding:r},n){let s=se(e,{encoding:r}),a=se(t,{encoding:r});try{return await Promise.all([n,s,a])}catch(o){return Promise.all([{error:o,exitCode:null,signal:o.signal,timedOut:o.timedOut||!1},ie(e,s),ie(t,a)])}}function Be(e){let t=typeof e=="string"?`
`:10,r=typeof e=="string"?"\r":13;return e[e.length-1]===t&&(e=e.slice(0,-1)),e[e.length-1]===r&&(e=e.slice(0,-1)),e}function oe(e,t){return e.stripFinalNewline?Be(t):t}function Ge({timedOut:e,timeout:t,signal:r,exitCode:n}){return e?`timed out after ${t} milliseconds`:r!=null?`was killed with ${r}`:n!=null?`failed with exit code ${n}`:"failed"}function Ke({stdout:e,stderr:t,error:r,signal:n,exitCode:s,command:a,timedOut:o,options:l,parentError:i}){let m=`Command ${Ge({timedOut:o,timeout:l?.timeout,signal:n,exitCode:s})}: ${a}`,$=r?`${m}
${r.message}`:m,T=[$,t,e].filter(Boolean).join(`
`);return r?r.originalMessage=r.message:r=i,r.message=T,r.shortMessage=$,r.command=a,r.exitCode=s,r.signal=n,r.stdout=e,r.stderr=t,"bufferedData"in r&&delete r.bufferedData,r}function He({stdout:e,stderr:t,error:r,exitCode:n,signal:s,timedOut:a,command:o,options:l,parentError:i}){if(r||n!==0||s!==null)throw Ke({error:r,exitCode:n,signal:s,stdout:e,stderr:t,command:o,timedOut:a,options:l,parentError:i});return e}var he=(function(e){return e.Required="required",e})({});function Y(e,t){if(e){if(typeof e=="function")return e(t);if(e==="required"){let r=typeof t<"u"&&t!==null;if(r)switch(typeof t){case"string":r=t.length>0;break;case"object":Array.isArray(t)?r=t.length>0:t instanceof Date&&(r=t.getTime()>0);break;default:break}if(!r)return"The item is required"}}}function pe(e){let{onSubmit:t,validation:r,initialValues:n={}}=e,[s,a]=(0,u.useState)(n),[o,l]=(0,u.useState)({}),i=(0,u.useRef)({}),c=S(r||{}),m=S(t),$=(0,u.useCallback)(g=>{i.current[g]?.focus()},[i]),T=(0,u.useCallback)(async g=>{let h=!1;for(let[w,k]of Object.entries(c.current)){let R=Y(k,g[w]);R&&(h||(h={},$(w)),h[w]=R)}if(h)return l(h),!1;let b=await m.current(g);return typeof b=="boolean"?b:!0},[c,m,$]),E=(0,u.useCallback)((g,h)=>{l(b=>({...b,[g]:h}))},[l]),A=(0,u.useCallback)(function(g,h){a(b=>({...b,[g]:typeof h=="function"?h(b[g]):h}))},[a]),y=(0,u.useMemo)(()=>new Proxy({},{get(g,h){let b=c.current[h],w=s[h];return{onChange(k){o[h]&&(Y(b,k)||E(h,void 0)),A(h,k)},onBlur(k){let R=Y(b,k.target.value);R&&E(h,R)},error:o[h],id:h,value:typeof w>"u"?null:w,ref:k=>{i.current[h]=k}}}}),[o,c,E,s,i,A]),I=(0,u.useCallback)(g=>{l({}),Object.entries(i.current).forEach(([h,b])=>{g?.[h]||b?.reset()}),g&&a(g)},[a,l,i]);return{handleSubmit:T,setValidationError:E,setValue:A,values:s,itemProps:y,focus:$,reset:I}}async function M(e,t,r){if(process.platform!=="darwin")throw new Error("AppleScript is only supported on macOS");let{humanReadableOutput:n,language:s,timeout:a,...o}=Array.isArray(t)?r||{}:t||{},l=n!==!1?[]:["-ss"];s==="JavaScript"&&l.push("-l","JavaScript"),Array.isArray(t)&&l.push("-",...t);let i=ce.default.spawn("osascript",l,{...o,env:{PATH:"/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"}}),c=Ne(i,{timeout:a??1e4});i.stdin.end(e);let[{error:m,exitCode:$,signal:T,timedOut:E},A,y]=await je(i,{encoding:"utf8"},c),I=oe({stripFinalNewline:!0},A),g=oe({stripFinalNewline:!0},y);return He({stdout:I,stderr:g,error:m,exitCode:$,signal:T,timedOut:E,command:"osascript",options:r,parentError:new Error})}var ge=require("@raycast/api"),me=!1;async function be(){if(process.platform!=="darwin"){me=!1;return}me=!!(await(0,ge.getApplications)()).find(r=>r.bundleId==="io.capacities.app")}var _=require("react");function $e(){let{data:e}=de(async()=>{if(process.platform!=="darwin")return;let t=await Je();if(!Ze.some(a=>a===t))return;let r=await ye[t]();if(!r)return;let{url:n,title:s}=qe(r);return{url:n,title:s}},[],{onError(){}});return e}function Je(){return M('tell application "System Events" to get name of (processes whose frontmost is true) as text')}var ye={"Google Chrome":()=>M('tell application "Google Chrome" to return {URL, title} of active tab of front window'),Arc:()=>M('tell application "Arc" to return {URL, title} of active tab of front window'),Safari:()=>M('tell application "Safari" to return {URL of front document, name of front document}'),firefox:()=>{},"Brave Browser":()=>M('tell application "Brave Browser" to return {URL, title} of active tab of front window')},Ze=Object.keys(ye);function qe(e){let t=e.indexOf(","),r=e.slice(0,t).trim(),n=e.slice(t+1).trim();return{url:r,title:n.trim()}}var V=require("@raycast/api"),B=require("react"),{bearerToken:Ye}=(0,V.getPreferenceValues)(),G="https://api.capacities.io",K={Accept:"application/json",Authorization:`Bearer ${Ye}`,"Content-Type":"application/json"},Xe=1e3*60*10,Qe=1e3*60*10;function H(e){return e===429?"Too Many Requests. Please try again later.":e===400?"Invalid request. Please try again.":e===401?"Unauthorized. Please check your API key.":e===500?"Something went wrong.":e===503||e===555?"Service Unavailable. Please try again later.":"Request failed. You might be offline, please try again when back online."}async function we(){let e=await V.LocalStorage.getItem("capacitiesStore");return e?JSON.parse(e):{spacesLastUpdated:void 0,spaces:[],spacesInfo:{}}}async function et(e,t){let r,n;try{if(n=await we(),e||!n.spacesLastUpdated||Date.now()-new Date(n.spacesLastUpdated).getTime()>Xe)try{let a=await fetch(`${G}/spaces`,{headers:K});if(!a.ok)throw new Error(H(a.status));let l=await a.json();l.spaces&&(n.spaces=l.spaces.map(c=>({id:c.id,title:c.title})));let i=l?.spaces||[];for(let c of i){let m=n.spaces.findIndex($=>$.id===c.id);m===-1?n.spaces.push({id:c.id,title:c.title}):n.spaces[m]={id:c.id,title:c.title}}n.spacesLastUpdated=new Date().toISOString()}catch(a){r=`${a}`}let s=[];for(let[a,o]of Object.entries(n.spacesInfo))n.spaces.find(l=>l.id===a)?(e||!o?.lastUpdated||Date.now()-new Date(o?.lastUpdated).getTime()>Qe)&&s.push(a):delete n.spacesInfo[a];for(let a of n.spaces)n.spacesInfo[a.id]||s.push(a.id);for(let a of s)try{let o=await fetch(`${G}/space-info?spaceid=${a}`,{headers:K});if(!o.ok)throw new Error(H(o.status));let i=await o.json();n.spacesInfo[a]={lastUpdated:new Date().toISOString(),structures:i.structures}}catch(o){r=`${o}`}if(r&&t)throw new Error(r);return await V.LocalStorage.setItem("capacitiesStore",JSON.stringify(n)),n}catch{if(!t&&n)return n;throw new Error(r||"Failed to load Capacities store")}}function ke(e=!1){let[t,r]=(0,B.useState)(!0),[n,s]=(0,B.useState)(void 0),[a,o]=(0,B.useState)(void 0);function l(){we().then(i=>{o(i),i.spacesLastUpdated&&r(!1)}).catch(i=>{console.error(i?.message),s("Failed to load Capacities store")}),et(e,!1).then(i=>{o(i),i.spacesLastUpdated?r(!1):s("Failed to load Capacities store")}).catch(i=>{s(i?.message||"Failed to load Capacities store")})}return{store:a,isLoading:t,error:n,triggerLoading:l}}var v=require("react/jsx-runtime");function xe(e){try{return new URL(e),!0}catch{return!1}}function ve(){(0,_.useEffect)(()=>{be()},[]);let{store:e,triggerLoading:t,isLoading:r}=ke();(0,_.useEffect)(()=>{t()},[]);let n=(0,_.useRef)(null),{handleSubmit:s,itemProps:a,setValue:o}=pe({async onSubmit(i){let c=await(0,p.showToast)(p.Toast.Style.Animated,"Saving"),m={spaceId:e?.spaces.length===1?e.spaces[0].id:i.spaceId,url:i.value,mdText:i.mdText,tags:i.tags?i.tags.split(","):[]};try{let $=await fetch(`${G}/save-weblink`,{method:"POST",headers:K,body:JSON.stringify(m)});if(!$.ok)throw new Error(H($.status));c.style=p.Toast.Style.Success,c.title="Saved",await(0,p.closeMainWindow)({popToRootType:p.PopToRootType.Immediate})}catch($){c.style=p.Toast.Style.Failure,c.title="Failed",c.message=`${$}`}},validation:{value(i){if(!i||i.trim()==="")return"A link is required";if(!xe(i))return"Invalid URL"},spaceId:n.current?he.Required:void 0,tags(i){if(i&&i.split(",").length>10)return"Maximum of 10 tags allowed."}}}),l=$e();return(0,_.useEffect)(()=>{async function i(){try{let{text:c}=await p.Clipboard.read();c&&xe(c)&&!a.value.value&&o("value",c)}catch(c){console.error(c)}}i()},[]),(0,_.useEffect)(()=>{l&&!a.value.value&&o("value",l.url)},[l]),(0,v.jsxs)(p.Form,{isLoading:r,actions:(0,v.jsx)(p.ActionPanel,{children:(0,v.jsx)(p.Action.SubmitForm,{title:"Create Weblink",icon:p.Icon.CheckCircle,onSubmit:s})}),children:[(0,v.jsx)(p.Form.TextField,{title:"Link",placeholder:"Link here",...a.value}),(0,v.jsx)(p.Form.TextField,{title:"Tags",placeholder:"Use a comma separated list of tags.",...a.tags,info:"Optional. Tags added to your web link object. Tags need to exactly match your tag names in Capacities, otherwise they will be created. You can add a maximum of 10 tags.",storeValue:!0}),(0,v.jsx)(p.Form.TextArea,{title:"Notes",...a.mdText,info:"Optional"}),e&&e.spaces.length>1&&(0,v.jsx)(v.Fragment,{children:(0,v.jsx)(p.Form.Dropdown,{title:"Space",...a.spaceId,storeValue:!0,onChange:()=>o("spaceId",""),ref:n,children:e.spaces&&e.spaces.map(i=>(0,v.jsx)(p.Form.Dropdown.Item,{value:i.id,title:i.title},i.id))})})]})}
