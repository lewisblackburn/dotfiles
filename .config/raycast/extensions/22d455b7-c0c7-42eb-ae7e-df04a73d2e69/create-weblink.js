"use strict";var Re=Object.create;var z=Object.defineProperty;var Ue=Object.getOwnPropertyDescriptor;var Ce=Object.getOwnPropertyNames;var Ie=Object.getPrototypeOf,Pe=Object.prototype.hasOwnProperty;var _e=(t,e)=>{for(var r in e)z(t,r,{get:e[r],enumerable:!0})},ne=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Ce(e))!Pe.call(t,a)&&a!==r&&z(t,a,{get:()=>e[a],enumerable:!(n=Ue(e,a))||n.enumerable});return t};var V=(t,e,r)=>(r=t!=null?Re(Ie(t)):{},ne(e||!t||!t.__esModule?z(r,"default",{value:t,enumerable:!0}):r,t)),Oe=t=>ne(z({},"__esModule",{value:!0}),t);var Qe={};_e(Qe,{default:()=>ke});module.exports=Oe(Qe);var p=require("@raycast/api");var l=V(require("react")),d=require("@raycast/api");var ae=Object.prototype.hasOwnProperty;function F(t,e){var r,n;if(t===e)return!0;if(t&&e&&(r=t.constructor)===e.constructor){if(r===Date)return t.getTime()===e.getTime();if(r===RegExp)return t.toString()===e.toString();if(r===Array){if((n=t.length)===e.length)for(;n--&&F(t[n],e[n]););return n===-1}if(!r||typeof t=="object"){n=0;for(r in t)if(ae.call(t,r)&&++n&&!ae.call(e,r)||!(r in e)||!F(t[r],e[r]))return!1;return Object.keys(e).length===n}}return t!==t&&e!==e}var _=V(require("node:fs")),B=V(require("node:path"));var le=V(require("node:child_process")),ue=require("node:buffer"),D=V(require("node:stream")),fe=require("node:util");var de=require("react/jsx-runtime");var J=globalThis;function Le(t){let e=(0,l.useRef)(t),r=(0,l.useRef)(0);return F(t,e.current)||(e.current=t,r.current+=1),(0,l.useMemo)(()=>e.current,[r.current])}function E(t){let e=(0,l.useRef)(t);return e.current=t,e}function De(t,e){let r=t instanceof Error?t.message:String(t);return(0,d.showToast)({style:d.Toast.Style.Failure,title:e?.title??"Something went wrong",message:e?.message??r,primaryAction:e?.primaryAction??se(t),secondaryAction:e?.primaryAction?se(t):void 0})}var se=t=>{let e=!0,r="[Extension Name]...",n="";try{let i=JSON.parse((0,_.readFileSync)((0,B.join)(d.environment.assetsPath,"..","package.json"),"utf8"));r=`[${i.title}]...`,n=`https://raycast.com/${i.owner||i.author}/${i.name}`,(!i.owner||i.access==="public")&&(e=!1)}catch{}let a=d.environment.isDevelopment||e,s=t instanceof Error?t?.stack||t?.message||"":String(t);return{title:a?"Copy Logs":"Report Error",onAction(i){i.hide(),a?d.Clipboard.copy(s):(0,d.open)(`https://github.com/raycast/extensions/issues/new?&labels=extension%2Cbug&template=extension_bug_report.yml&title=${encodeURIComponent(r)}&extension-url=${encodeURI(n)}&description=${encodeURIComponent(`#### Error:
\`\`\`
${s}
\`\`\`
`)}`)}}};function he(t,e,r){let n=(0,l.useRef)(0),[a,s]=(0,l.useState)({isLoading:!0}),i=E(t),c=E(r?.abortable),o=E(e||[]),f=E(r?.onError),m=E(r?.onData),S=E(r?.onWillExecute),R=E(r?.failureToastOptions),A=E(a.data),T=(0,l.useRef)(null),y=(0,l.useRef)({page:0}),I=(0,l.useRef)(!1),g=(0,l.useRef)(!0),h=(0,l.useRef)(50),b=(0,l.useCallback)(()=>(c.current&&(c.current.current?.abort(),c.current.current=new AbortController),++n.current),[c]),w=(0,l.useCallback)((...C)=>{let x=b();S.current?.(C),s(u=>({...u,isLoading:!0}));let O=Me(i.current)(...C);function L(u){return u.name=="AbortError"||x===n.current&&(f.current?f.current(u):d.environment.launchType!==d.LaunchType.Background&&De(u,{title:"Failed to fetch latest data",primaryAction:{title:"Retry",onAction(P){P.hide(),T.current?.(...o.current||[])}},...R.current}),s({error:u,isLoading:!1})),u}return typeof O=="function"?(I.current=!0,O(y.current).then(({data:u,hasMore:P,cursor:Ae})=>(x===n.current&&(y.current&&(y.current.cursor=Ae,y.current.lastItem=u?.[u.length-1]),m.current&&m.current(u,y.current),P&&(h.current=u.length),g.current=P,s(Te=>y.current.page===0?{data:u,isLoading:!1}:{data:(Te.data||[])?.concat(u),isLoading:!1})),u),u=>(g.current=!1,L(u)))):(I.current=!1,O.then(u=>(x===n.current&&(m.current&&m.current(u),s({data:u,isLoading:!1})),u),L))},[m,f,o,i,s,T,S,y,R,b]);T.current=w;let k=(0,l.useCallback)(()=>{y.current={page:0};let C=o.current||[];return w(...C)},[w,o]),U=(0,l.useCallback)(async(C,x)=>{let O;try{if(x?.optimisticUpdate){b(),typeof x?.rollbackOnError!="function"&&x?.rollbackOnError!==!1&&(O=structuredClone(A.current?.value));let L=x.optimisticUpdate;s(u=>({...u,data:L(u.data)}))}return await C}catch(L){if(typeof x?.rollbackOnError=="function"){let u=x.rollbackOnError;s(P=>({...P,data:u(P.data)}))}else x?.optimisticUpdate&&x?.rollbackOnError!==!1&&s(u=>({...u,data:O}));throw L}finally{x?.shouldRevalidateAfter!==!1&&(d.environment.launchType===d.LaunchType.Background||d.environment.commandMode==="menu-bar"?await k():k())}},[k,A,s,b]),xe=(0,l.useCallback)(()=>{y.current.page+=1;let C=o.current||[];w(...C)},[y,o,w]);(0,l.useEffect)(()=>{y.current={page:0},r?.execute!==!1?w(...e||[]):b()},[Le([e,r?.execute,w]),c,y]),(0,l.useEffect)(()=>()=>{b()},[b]);let ve=r?.execute!==!1?a.isLoading:!1,Se={...a,isLoading:ve},Ee=I.current?{pageSize:h.current,hasMore:g.current,onLoadMore:xe}:void 0;return{...Se,revalidate:k,mutate:U,pagination:Ee}}function Me(t){return t===Promise.all||t===Promise.race||t===Promise.resolve||t===Promise.reject?t.bind(Promise):t}var j=t=>!!t&&typeof t=="object"&&typeof t.removeListener=="function"&&typeof t.emit=="function"&&typeof t.reallyExit=="function"&&typeof t.listeners=="function"&&typeof t.kill=="function"&&typeof t.pid=="number"&&typeof t.on=="function",Z=Symbol.for("signal-exit emitter"),X=class{constructor(){if(this.emitted={afterExit:!1,exit:!1},this.listeners={afterExit:[],exit:[]},this.count=0,this.id=Math.random(),J[Z])return J[Z];Object.defineProperty(J,Z,{value:this,writable:!1,enumerable:!1,configurable:!1})}on(e,r){this.listeners[e].push(r)}removeListener(e,r){let n=this.listeners[e],a=n.indexOf(r);a!==-1&&(a===0&&n.length===1?n.length=0:n.splice(a,1))}emit(e,r,n){if(this.emitted[e])return!1;this.emitted[e]=!0;let a=!1;for(let s of this.listeners[e])a=s(r,n)===!0||a;return e==="exit"&&(a=this.emit("afterExit",r,n)||a),a}},Q=class{onExit(){return()=>{}}load(){}unload(){}},ee=class{#o;#t;#e;#s;#i;#a;#n;#r;constructor(e){this.#o=process.platform==="win32"?"SIGINT":"SIGHUP",this.#t=new X,this.#a={},this.#n=!1,this.#r=[],this.#r.push("SIGHUP","SIGINT","SIGTERM"),globalThis.process.platform!=="win32"&&this.#r.push("SIGALRM","SIGABRT","SIGVTALRM","SIGXCPU","SIGXFSZ","SIGUSR2","SIGTRAP","SIGSYS","SIGQUIT","SIGIOT"),globalThis.process.platform==="linux"&&this.#r.push("SIGIO","SIGPOLL","SIGPWR","SIGSTKFLT"),this.#e=e,this.#a={};for(let r of this.#r)this.#a[r]=()=>{let n=this.#e.listeners(r),{count:a}=this.#t,s=e;if(typeof s.__signal_exit_emitter__=="object"&&typeof s.__signal_exit_emitter__.count=="number"&&(a+=s.__signal_exit_emitter__.count),n.length===a){this.unload();let i=this.#t.emit("exit",null,r),c=r==="SIGHUP"?this.#o:r;i||e.kill(e.pid,c)}};this.#i=e.reallyExit,this.#s=e.emit}onExit(e,r){if(!j(this.#e))return()=>{};this.#n===!1&&this.load();let n=r?.alwaysLast?"afterExit":"exit";return this.#t.on(n,e),()=>{this.#t.removeListener(n,e),this.#t.listeners.exit.length===0&&this.#t.listeners.afterExit.length===0&&this.unload()}}load(){if(!this.#n){this.#n=!0,this.#t.count+=1;for(let e of this.#r)try{let r=this.#a[e];r&&this.#e.on(e,r)}catch{}this.#e.emit=(e,...r)=>this.#l(e,...r),this.#e.reallyExit=e=>this.#c(e)}}unload(){this.#n&&(this.#n=!1,this.#r.forEach(e=>{let r=this.#a[e];if(!r)throw new Error("Listener not defined for signal: "+e);try{this.#e.removeListener(e,r)}catch{}}),this.#e.emit=this.#s,this.#e.reallyExit=this.#i,this.#t.count-=1)}#c(e){return j(this.#e)?(this.#e.exitCode=e||0,this.#t.emit("exit",this.#e.exitCode,null),this.#i.call(this.#e,this.#e.exitCode)):0}#l(e,...r){let n=this.#s;if(e==="exit"&&j(this.#e)){typeof r[0]=="number"&&(this.#e.exitCode=r[0]);let a=n.call(this.#e,e,...r);return this.#t.emit("exit",this.#e.exitCode,null),a}else return n.call(this.#e,e,...r)}},q=null,We=(t,e)=>(q||(q=j(process)?new ee(process):new Q),q.onExit(t,e));function Ve(t,{timeout:e}={}){let r=new Promise((c,o)=>{t.on("exit",(f,m)=>{c({exitCode:f,signal:m,timedOut:!1})}),t.on("error",f=>{o(f)}),t.stdin&&t.stdin.on("error",f=>{o(f)})}),n=We(()=>{t.kill()});if(e===0||e===void 0)return r.finally(()=>n());let a,s=new Promise((c,o)=>{a=setTimeout(()=>{t.kill("SIGTERM"),o(Object.assign(new Error("Timed out"),{timedOut:!0,signal:"SIGTERM"}))},e)}),i=r.finally(()=>{clearTimeout(a)});return Promise.race([s,i]).finally(()=>n())}var te=class extends Error{constructor(){super("The output is too big"),this.name="MaxBufferError"}};function Ne(t){let{encoding:e}=t,r=e==="buffer",n=new D.default.PassThrough({objectMode:!1});e&&e!=="buffer"&&n.setEncoding(e);let a=0,s=[];return n.on("data",i=>{s.push(i),a+=i.length}),n.getBufferedValue=()=>r?Buffer.concat(s,a):s.join(""),n.getBufferedLength=()=>a,n}async function ie(t,e){let r=Ne(e);return await new Promise((n,a)=>{let s=i=>{i&&r.getBufferedLength()<=ue.constants.MAX_LENGTH&&(i.bufferedData=r.getBufferedValue()),a(i)};(async()=>{try{await(0,fe.promisify)(D.default.pipeline)(t,r),n()}catch(i){s(i)}})(),r.on("data",()=>{r.getBufferedLength()>8e7&&s(new te)})}),r.getBufferedValue()}async function oe(t,e){t.destroy();try{return await e}catch(r){return r.bufferedData}}async function ze({stdout:t,stderr:e},{encoding:r},n){let a=ie(t,{encoding:r}),s=ie(e,{encoding:r});try{return await Promise.all([n,a,s])}catch(i){return Promise.all([{error:i,exitCode:null,signal:i.signal,timedOut:i.timedOut||!1},oe(t,a),oe(e,s)])}}function Fe(t){let e=typeof t=="string"?`
`:10,r=typeof t=="string"?"\r":13;return t[t.length-1]===e&&(t=t.slice(0,-1)),t[t.length-1]===r&&(t=t.slice(0,-1)),t}function ce(t,e){return t.stripFinalNewline?Fe(e):e}function je({timedOut:t,timeout:e,signal:r,exitCode:n}){return t?`timed out after ${e} milliseconds`:r!=null?`was killed with ${r}`:n!=null?`failed with exit code ${n}`:"failed"}function Be({stdout:t,stderr:e,error:r,signal:n,exitCode:a,command:s,timedOut:i,options:c,parentError:o}){let m=`Command ${je({timedOut:i,timeout:c?.timeout,signal:n,exitCode:a})}: ${s}`,S=r?`${m}
${r.message}`:m,R=[S,e,t].filter(Boolean).join(`
`);return r?r.originalMessage=r.message:r=o,r.message=R,r.shortMessage=S,r.command=s,r.exitCode=a,r.signal=n,r.stdout=t,r.stderr=e,"bufferedData"in r&&delete r.bufferedData,r}function Ge({stdout:t,stderr:e,error:r,exitCode:n,signal:a,timedOut:s,command:i,options:c,parentError:o}){if(r||n!==0||a!==null)throw Be({error:r,exitCode:n,signal:a,stdout:t,stderr:e,command:i,timedOut:s,options:c,parentError:o});return t}var pe=(function(t){return t.Required="required",t})({});function Y(t,e){if(t){if(typeof t=="function")return t(e);if(t==="required"){let r=typeof e<"u"&&e!==null;if(r)switch(typeof e){case"string":r=e.length>0;break;case"object":Array.isArray(e)?r=e.length>0:e instanceof Date&&(r=e.getTime()>0);break;default:break}if(!r)return"The item is required"}}}function me(t){let{onSubmit:e,validation:r,initialValues:n={}}=t,[a,s]=(0,l.useState)(n),[i,c]=(0,l.useState)({}),o=(0,l.useRef)({}),f=E(r||{}),m=E(e),S=(0,l.useCallback)(g=>{o.current[g]?.focus()},[o]),R=(0,l.useCallback)(async g=>{let h=!1;for(let[w,k]of Object.entries(f.current)){let U=Y(k,g[w]);U&&(h||(h={},S(w)),h[w]=U)}if(h)return c(h),!1;let b=await m.current(g);return typeof b=="boolean"?b:!0},[f,m,S]),A=(0,l.useCallback)((g,h)=>{c(b=>({...b,[g]:h}))},[c]),T=(0,l.useCallback)(function(g,h){s(b=>({...b,[g]:typeof h=="function"?h(b[g]):h}))},[s]),y=(0,l.useMemo)(()=>new Proxy({},{get(g,h){let b=f.current[h],w=a[h];return{onChange(k){i[h]&&(Y(b,k)||A(h,void 0)),T(h,k)},onBlur(k){let U=Y(b,k.target.value);U&&A(h,U)},error:i[h],id:h,value:typeof w>"u"?null:w,ref:k=>{o.current[h]=k}}}}),[i,f,A,a,o,T]),I=(0,l.useCallback)(g=>{c({}),Object.entries(o.current).forEach(([h,b])=>{g?.[h]||b?.reset()}),g&&s(g)},[s,c,o]);return{handleSubmit:R,setValidationError:A,setValue:T,values:a,itemProps:y,focus:S,reset:I}}async function M(t,e,r){if(process.platform!=="darwin")throw new Error("AppleScript is only supported on macOS");let{humanReadableOutput:n,language:a,timeout:s,...i}=Array.isArray(e)?r||{}:e||{},c=n!==!1?[]:["-ss"];a==="JavaScript"&&c.push("-l","JavaScript"),Array.isArray(e)&&c.push("-",...e);let o=le.default.spawn("osascript",c,{...i,env:{PATH:"/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"}}),f=Ve(o,{timeout:s??1e4});o.stdin.end(t);let[{error:m,exitCode:S,signal:R,timedOut:A},T,y]=await ze(o,{encoding:"utf8"},f),I=ce({stripFinalNewline:!0},T),g=ce({stripFinalNewline:!0},y);return Ge({stdout:I,stderr:g,error:m,exitCode:S,signal:R,timedOut:A,command:"osascript",options:r,parentError:new Error})}var W=require("react");function ge(){let{data:t}=he(async()=>{if(process.platform!=="darwin")return;let e=await Ke();if(!He.some(s=>s===e))return;let r=await be[e]();if(!r)return;let{url:n,title:a}=Je(r);return{url:n,title:a}},[],{onError(){}});return t}function Ke(){return M('tell application "System Events" to get name of (processes whose frontmost is true) as text')}var be={"Google Chrome":()=>M('tell application "Google Chrome" to return {URL, title} of active tab of front window'),Arc:()=>M('tell application "Arc" to return {URL, title} of active tab of front window'),Safari:()=>M('tell application "Safari" to return {URL of front document, name of front document}'),firefox:()=>{},"Brave Browser":()=>M('tell application "Brave Browser" to return {URL, title} of active tab of front window')},He=Object.keys(be);function Je(t){let e=t.indexOf(","),r=t.slice(0,e).trim(),n=t.slice(e+1).trim();return{url:r,title:n.trim()}}var $=require("@raycast/api"),re=require("react"),{communicationToken:Ze}=(0,$.getPreferenceValues)(),G="http://localhost:10334",K={Accept:"application/json",Authorization:`Bearer ${Ze}`,"Content-Type":"application/json"},qe=0,Ye=0;function H(t){if(t.ok)return;t.status===401?(0,$.showToast)({style:$.Toast.Style.Failure,title:"You're communication token is invalid",message:"Please update your communication token in the extension preferences and try again.",primaryAction:{title:"Open Extension Preferences",onAction:()=>(0,$.openExtensionPreferences)(),shortcut:{modifiers:["cmd"],key:"o"}}}):(0,$.showToast)({style:$.Toast.Style.Failure,title:"Something went wrong",message:`Error Message: ${t.status} - ${t.statusText}`})}function N(t){t.message.includes("fetch failed")?(0,$.showToast)({style:$.Toast.Style.Failure,title:"Cannot connect",message:"Capacities needs to be open for the extension to work. Please open Capacities and try again. If the problem persists, please check if you activated the extension in the Capacities settings.",primaryAction:{title:"Open Capacities",onAction:()=>(0,$.open)("capacities://","Capacities"),shortcut:{modifiers:["cmd"],key:"o"}}}):(0,$.showToast)({style:$.Toast.Style.Failure,title:"An unexpected error occurred",message:`Capacities needs to be open for the extension to work. Please open Capacities and try again. If the problem persists, please check if you activated the extension in the Capacities settings. (Error Message: ${t.message})`,primaryAction:{title:"Open Capacities",onAction:()=>(0,$.open)("capacities://","Capacities"),shortcut:{modifiers:["cmd"],key:"o"}}})}async function $e(){let t=await $.LocalStorage.getItem("capacitiesStore");return t?JSON.parse(t):{spacesLastUpdated:void 0,spaces:[],spacesInfo:{}}}async function Xe(t){let e;try{if(e=await $e(),t||!e.spacesLastUpdated||Date.now()-new Date(e.spacesLastUpdated).getTime()>qe){let n=await fetch(`${G}/spaces`,{headers:K});if(!n.ok)return H(n),e;let s=await n.json();s.spaces&&(e.spaces=s.spaces.map(c=>({id:c.id,title:c.title})));let i=s?.spaces||[];for(let c of i){let o=e.spaces.findIndex(f=>f.id===c.id);o===-1?e.spaces.push({id:c.id,title:c.title}):e.spaces[o]={id:c.id,title:c.title}}e.spacesLastUpdated=new Date().toISOString()}let r=[];for(let[n,a]of Object.entries(e.spacesInfo))e.spaces.find(s=>s.id===n)?(t||!a?.lastUpdated||Date.now()-new Date(a?.lastUpdated).getTime()>Ye)&&r.push(n):delete e.spacesInfo[n];for(let n of e.spaces)e.spacesInfo[n.id]||r.push(n.id);for(let n of r){let a=await fetch(`${G}/space-info?spaceid=${n}`,{headers:K});if(!a.ok)return H(a),e;let i=await a.json();e.spacesInfo[n]={lastUpdated:new Date().toISOString(),structures:i.structures}}return await $.LocalStorage.setItem("capacitiesStore",JSON.stringify(e)),e}catch(r){r instanceof Error?N(r):console.log(r);return}}function ye(t=!1){let[e,r]=(0,re.useState)(!0),[n,a]=(0,re.useState)(void 0);function s(){$e().then(i=>{a(i),i.spacesLastUpdated&&r(!1)}).catch(i=>{i instanceof Error?N(i):console.log(i)}),Xe(t).then(i=>{i&&(a(i),i.spacesLastUpdated?r(!1):N(new Error("Failed to load Capacities store")))})}return{store:n,isLoading:e,triggerLoading:s}}var v=require("react/jsx-runtime");function we(t){try{return new URL(t),!0}catch{return!1}}function ke(){let{store:t,triggerLoading:e,isLoading:r}=ye();(0,W.useEffect)(()=>{e()},[]);let n=(0,W.useRef)(null),{handleSubmit:a,itemProps:s,setValue:i}=me({async onSubmit(o){(0,p.showToast)({style:p.Toast.Style.Animated,title:"Saving"});let f={spaceId:t?.spaces.length===1?t.spaces[0].id:o.spaceId,url:o.value,mdText:o.mdText,tags:o.tags?o.tags.split(","):[]};try{let m=await fetch(`${G}/save-weblink`,{method:"POST",headers:K,body:JSON.stringify(f)});if(!m.ok){H(m);return}(0,p.showToast)({style:p.Toast.Style.Success,title:"Saved"}),(0,p.showHUD)("Weblink created"),(0,p.closeMainWindow)()}catch(m){m instanceof Error?N(m):console.log(m)}},validation:{value(o){if(!o||o.trim()==="")return"A link is required";if(!we(o))return"Invalid URL"},spaceId:n.current?pe.Required:void 0,tags(o){if(o&&o.split(",").length>10)return"Maximum of 10 tags allowed."}}}),c=ge();return(0,W.useEffect)(()=>{async function o(){try{let{text:f}=await p.Clipboard.read();f&&we(f)&&!s.value.value&&i("value",f)}catch(f){console.error(f)}}o()},[]),(0,W.useEffect)(()=>{c&&!s.value.value&&i("value",c.url)},[c]),(0,v.jsxs)(p.Form,{isLoading:r,actions:(0,v.jsx)(p.ActionPanel,{children:(0,v.jsx)(p.Action.SubmitForm,{title:"Create Weblink",icon:p.Icon.CheckCircle,onSubmit:a})}),children:[t&&t.spaces.length>1&&(0,v.jsx)(v.Fragment,{children:(0,v.jsx)(p.Form.Dropdown,{title:"Space",...s.spaceId,storeValue:!0,onChange:()=>i("spaceId",""),ref:n,children:t.spaces&&t.spaces.map(o=>(0,v.jsx)(p.Form.Dropdown.Item,{value:o.id,title:o.title,icon:p.Icon.Desktop},o.id))})}),(0,v.jsx)(p.Form.TextField,{title:"Link",...s.value,autoFocus:!0}),(0,v.jsx)(p.Form.TextField,{title:"Tags",placeholder:"Use a comma separated list of tags.",...s.tags,info:"Optional. Tags added to your web link object. Tags need to exactly match your tag names in Capacities, otherwise they will be created. You can add a maximum of 10 tags.",storeValue:!0}),(0,v.jsx)(p.Form.TextArea,{title:"Notes",...s.mdText,info:"Optional. Notes can be formatted in markdown."})]})}
